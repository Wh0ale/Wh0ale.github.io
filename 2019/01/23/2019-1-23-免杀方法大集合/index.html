<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/128x128.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/128x128.ico?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/128x128.ico?v=7.3.0">
  <meta name="google-site-verification" content="GGFme5OaJm26Z2TDjB--Ol2pfQANqnR69mkuVsw70rU">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: 'search.xml'
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'copy',
      copy_success: 'succeed',
      copy_failure: 'failed'
    }
  };
</script>

  <meta name="description" content="概述什么是免杀？来自百科的注解：  免杀，也就是反病毒（AntiVirus）与反间谍（AntiSpyware）的对立面，英文为Anti-AntiVirus（简写Virus AV），逐字翻译为“反-反病毒”，翻译为“反杀毒技术”。  有本比较有名的书，想详细学习的同学可以去看看。《黑客免杀攻防》  其实我大概好像只看过目录…( ╯□╰ )  下面我介绍的是自己实践的一些方法，有没有效果，试试就知道了">
<meta name="keywords" content="免杀">
<meta property="og:type" content="article">
<meta property="og:title" content="免杀方法大集结">
<meta property="og:url" content="https://wh0ale.github.io/2019/01/23/2019-1-23-免杀方法大集合/index.html">
<meta property="og:site_name" content="Wh0ale&#39;s Blog">
<meta property="og:description" content="概述什么是免杀？来自百科的注解：  免杀，也就是反病毒（AntiVirus）与反间谍（AntiSpyware）的对立面，英文为Anti-AntiVirus（简写Virus AV），逐字翻译为“反-反病毒”，翻译为“反杀毒技术”。  有本比较有名的书，想详细学习的同学可以去看看。《黑客免杀攻防》  其实我大概好像只看过目录…( ╯□╰ )  下面我介绍的是自己实践的一些方法，有没有效果，试试就知道了">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-12-22T03:31:06.619Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="免杀方法大集结">
<meta name="twitter:description" content="概述什么是免杀？来自百科的注解：  免杀，也就是反病毒（AntiVirus）与反间谍（AntiSpyware）的对立面，英文为Anti-AntiVirus（简写Virus AV），逐字翻译为“反-反病毒”，翻译为“反杀毒技术”。  有本比较有名的书，想详细学习的同学可以去看看。《黑客免杀攻防》  其实我大概好像只看过目录…( ╯□╰ )  下面我介绍的是自己实践的一些方法，有没有效果，试试就知道了">
  <link rel="alternate" href="/atom.xml" title="Wh0ale's Blog" type="application/atom+xml">
  <link rel="canonical" href="https://wh0ale.github.io/2019/01/23/2019-1-23-免杀方法大集合/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>免杀方法大集结 | Wh0ale's Blog</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wh0ale's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        <li class="menu-item menu-item-search">
          <a href="javascript:;" class="popup-trigger">
          
            <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>


    </div>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    <div class="reading-progress-bar"></div>

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wh0ale.github.io/2019/01/23/2019-1-23-免杀方法大集合/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wh0ale">
      <meta itemprop="description" content="No master and rookie，only hardworking and lazy.">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wh0ale's Blog">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">免杀方法大集结

              
            
          </h1>
        

        <div class="post-meta">
        
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-23 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-23T00:00:00+08:00">2019-01-23</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-12-22 11:31:06" itemprop="dateModified" datetime="2019-12-22T11:31:06+08:00">2019-12-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/红队/" itemprop="url" rel="index"><span itemprop="name">红队</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon"
              >
                <i class="fa fa-eye"></i>
                 阅读次数： 
                <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
              </span>
            </span>
          <br>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">5.2k</span>
            </span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">5 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">



      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>什么是免杀？来自百科的注解：</p>
<blockquote>
<p>免杀，也就是反病毒（AntiVirus）与反间谍（AntiSpyware）的对立面，英文为Anti-AntiVirus（简写Virus AV），逐字翻译为“反-反病毒”，翻译为“反杀毒技术”。</p>
</blockquote>
<p>有本比较有名的书，想详细学习的同学可以去看看。《黑客免杀攻防》</p>
<blockquote>
<p>其实我大概好像只看过目录…( ╯□╰ )</p>
</blockquote>
<p>下面我介绍的是自己实践的一些方法，有没有效果，试试就知道了。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>免杀大概可以分为两种情况：</p>
<ol>
<li>二进制的免杀（无源码），只能通过通过修改asm代码／二进制数据／其他数据来完成免杀。</li>
<li>有源码的免杀，可以通过修改源代码来完成免杀，也可以结合二进制免杀的技术。</li>
</ol>
<p>免杀也可以分为这两种情况：</p>
<ol>
<li>静态文件免杀，被杀毒软件病毒库/云查杀了，也就是文件特征码在病毒库了。免杀方式可能是上面的两种方式，看情况。</li>
<li>动态行为免杀，运行中执行的某些行为被杀毒软件拦截报读。行为免杀如果没有源码就不是很好搞了。</li>
</ol>
<p>下面就静态和动态免杀来详细说说免杀的技术。</p>
<h1 id="静态免杀"><a href="#静态免杀" class="headerlink" title="静态免杀"></a>静态免杀</h1><p>对于静态免杀，针对的是杀毒软件的静态文件扫描，云查（病毒库）杀。</p>
<p>杀毒是提取文件一段特征码来识别病毒文件。</p>
<blockquote>
<p>能识别一个程序是一个病毒的一段不大于64字节的特征串</p>
</blockquote>
<p>那杀毒软件是怎么提取文件特征码的？</p>
<p>如果我们知道了一个文件是病毒，那么通过md5肯定可以判断一个就是这个病毒文件，那如果该病毒文件做了小小变动呢，直接md5肯定是不行了，那杀毒软件是怎么做的呢？这里有个叫做模糊哈希（<code>Fuzzy Hashing</code>）算法的东西。</p>
<blockquote>
<p>模糊哈希算法又叫基于内容分割的分片分片哈希算法（context triggered piecewise hashing, CTPH），主要用于文件的相似性比较。</p>
</blockquote>
<p>大致就可以理解为，不要把一个文件的所有内容都拿来计算hash，而通过分片，取出部分重要（不易改变）的内容进行hash计算，这样就能达到通过一个特征码找到类似的病毒变种。</p>
<p>关于模糊哈希更加详细的内容可以查看文章后面的参考文章，这里不再详述。</p>
<p>具体杀毒软件是不是通过这个算法来计算特征码的，我也不能完全肯定（纯猜测加网上一点点信息），但是根据免杀的经验可以总结出几点：</p>
<ol>
<li>特征码会有多个串组合（减少误报）</li>
<li>代码数据（肯定有）</li>
<li>会解析PE，检查附加文件数据、PE文件的资源等等</li>
</ol>
<h2 id="怎么找特征码"><a href="#怎么找特征码" class="headerlink" title="怎么找特征码"></a>怎么找特征码</h2><h3 id="工具查找"><a href="#工具查找" class="headerlink" title="工具查找"></a>工具查找</h3><p>常见的特征码定位工具有CCL、MYCCL。工具大致原理就是分割文件，某些分割部分填入数据(0)，如果扫描该部分不报警，则特征码在这个部分。如此反复，直到找到很短的某一段内容。不同工具之前局别是使用的分割算法不同，查找特征码的效果不同。</p>
<blockquote>
<p>目前比较常有名气的特征码定位器主要有CCL与MYCCL，他们都采用文件分块定位的办法，定位效果带有运气成份，且可能每次定位出的位置都不尽相同，这个免杀带来了困难。</p>
</blockquote>
<p>后来出来了一款新的特征码定位软件<code>VirTest</code>。下面是作者自己的介绍：</p>
<blockquote>
<p>我们可以这样假设报毒过程，如果检测文件是PE,如果在CODE位置存在 标志A,在DATA位置存在标志B,在资源位置存在标志C,同时满足这个3个条件，那么杀软就会报毒,VIRTEST工作原理就是要找到引起报毒最后一个标志，也就是假设中的标志C。</p>
<p>因此VIRTEST采用2分排除法，测试标志C所在文件中的位置，由于被杀的文件可能存在多个 类似于ABC这样的连锁条件，所以我们必须要通过一种排除机制，先要找最靠近文件前部的连锁条件，排除掉文件尾部数据，当找到第一个连锁条件后，抹掉引标志C，再恢复尾部数据，</p>
<p>然后继续测试另外的连锁条件，直到找到最后一个连锁条件，抹掉后，整个文件免杀了，则说明特征代码被定为完毕了，所以VIRTEST绝对可以精确的定位出所有的复合特征。这比文件分块定位法先进得多，更为科学。</p>
</blockquote>
<p>工具查找肯定是针对二进制文件（有源码的也编译后在检查）。</p>
<p>具体用过MYCCL（使用方法自行查找），确实比手工分割文件定位方便，也可以找到某些文件的特征码，但是有些时候可能会出现非常多非常多…的被杀文件分割，然后…崩溃了。</p>
<p>后来也用了virtest，感觉作者说的挺有道理，应该挺好用吧。然后试了试，确实感觉比MYCCL高大上多了，也可以定位到特征码，但是tmd改了之后怎么还是报呢，反正你可能会折腾很久…</p>
<h3 id="手工查找"><a href="#手工查找" class="headerlink" title="手工查找"></a>手工查找</h3><p>这里说的是针对有源码的（二进制就别想手工了…），方法非常简单。</p>
<ol>
<li>mian中屏蔽所有代码，编译，扫描。不报的话继续2，如果依然报毒，去5。</li>
<li>放开一层（可以多层、二分也可以）函数，编译，扫描。不报的话，重复2。直到定位到某个函数或者多个函数，进入3。</li>
<li>在函数内部屏蔽部分代码（二分），编译，扫描。不报，重复2。</li>
<li>直到定位某段代码（无自定义内部调用），特征码在此。</li>
<li>是不是有附加数据，或者资源存储的文件。有，单独检查该文件或者数据，方法从1开始。如果没有，那去找找PE头吧。</li>
</ol>
<p>大致流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1. sub1 //未报</span><br><span class="line">2. sub1 sub2 //未报</span><br><span class="line">3. sub1 sub2 sub3 //报</span><br><span class="line">4. sub1 sub2 sub3(sub31) //未报</span><br><span class="line">5. sub1 sub2 sub3(sub31 sub32) //报</span><br><span class="line">6. sub1 sub2 sub3(sub31 sub32(sub321)) //报</span><br><span class="line">...</span><br><span class="line">直到找到某API调用，或者逻辑代码（没有自定义函数调用）</span><br></pre></td></tr></table></figure>

<p>此方法，虽然笨，但是定位特征码不会很慢，挺准确。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>别找了，直接盲免杀吧（后面具体看，有效）</p>
<h2 id="怎么免杀？"><a href="#怎么免杀？" class="headerlink" title="怎么免杀？"></a>怎么免杀？</h2><p>前面已经找到特征码了，怎么免杀呢？</p>
<p>其实前面已经说到了，找到特征码之后，只要改变这个特征码值得话就免杀成功。如果不需要软件正常运行，直接填零得了…开玩笑，这怎么可能。所以修改特征码还得保证软件正常功能。所以也是有讲究的。</p>
<p>常用的修改工具有，OD，C32ASM，UE，010Editor等等。</p>
<h3 id="手工修改"><a href="#手工修改" class="headerlink" title="手工修改"></a>手工修改</h3><h4 id="非源码"><a href="#非源码" class="headerlink" title="非源码"></a>非源码</h4><p><strong>1. 数据</strong></p>
<p>如果特征码定位到数据（通过IDA/OD等确认），其实不好修改，稍微不慎就会导致程序不能运行，或者影响程序运行流程或结果。</p>
<ul>
<li>字符串，如果不影响程序逻辑，可以替换大小写；如果无关紧要的数据，随意替换；等等，看情况而定。</li>
<li>整数，如果不影响结果，替换值，清零等等操作。</li>
<li>地址，基本应该不能修改，具体看情况。</li>
<li>PE头数据，根据PE结构具体来看，无用数据清零或修改，有用数据看情况修改。</li>
<li>最后，终极修改方法，找到访问数据的代码，直接修改代码访问数据的地址，数据也可以放到其他地址了，其实就如同修改源码一样修改，肯定没有修改源码那么容易（见后）。</li>
</ul>
<p>反正特征码定位到数据位置不容易修改（可以再试试后面的盲免杀）。</p>
<p><strong>2. 代码</strong></p>
<p>如果特征码定位到代码（也通过IDA/OD等确认），在不改变程序功能基础上，应用各种方法修改。</p>
<ul>
<li>等价替换汇编代码，如mov eax，0可以换成xor eax，eax，直接结果相同，二进制代码不同。</li>
<li>交换代码顺序，在不影响逻辑的情况下。</li>
<li>代码块移位，将代码块移动不用的内存位置，通过加入jmp addr跳过去执行，addr是新的代码块地址。</li>
</ul>
<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p>在有源码的情况下，修改的方式就更灵活了，更简单了。</p>
<ul>
<li>如果特征码是数据，那么修改数据位置，访问数据的代码位置等（思想类比非源码方式）。</li>
<li>加花指令，这是最有效也是最常用的方式，要点在于如何加话指令。</li>
</ul>
<ol>
<li>加数据计算代码，加减乘除各类组合。</li>
<li>加字符串操作代码，增加、删除、查找、替换等。</li>
<li>加多层跳转，跳转间加无效指令（不会执行的）。</li>
<li>加貌似有效的API调用，如LoadLibrary+GetProcAddr+API等。</li>
<li>等等。</li>
</ol>
<h3 id="工具免杀（盲免杀）"><a href="#工具免杀（盲免杀）" class="headerlink" title="工具免杀（盲免杀）"></a>工具免杀（盲免杀）</h3><p>在没找到有效的特征码，或者不好修改的时候，可以试试这种方式。</p>
<h4 id="资源操作"><a href="#资源操作" class="headerlink" title="资源操作"></a>资源操作</h4><p><strong>1. 加资源</strong></p>
<p>使用ResHacker对文件进行资源操作，找来多个正常软件，将它们的资源加入到自己软件，如图片，版本信息，对话框等。</p>
<p><strong>2. 替换资源</strong></p>
<p>使用ResHacker替换无用的资源（Version等）。</p>
<p><strong>3. 加签名</strong></p>
<p>使用签名伪造工具，将正常软件的签名信息加入到自己软件中。</p>
<p>几种方式可以交替重复多次进行组合使用。</p>
<h4 id="PE操作"><a href="#PE操作" class="headerlink" title="PE操作"></a>PE操作</h4><p><strong>1. PE优化</strong></p>
<p>使用PE优化工具对文件进行优化，删除0，PE头优化，附加数据等。</p>
<p><strong>2. 增加节</strong></p>
<p>增加节数据，随意加入无效数据。</p>
<h4 id="加壳"><a href="#加壳" class="headerlink" title="加壳"></a>加壳</h4><p>可以将加壳简单理解为：解密器/解压器+加密器/压缩器（原始代码）。</p>
<p>通过加密器/压缩器将原始代码进行加密压缩，让其特征码变化隐藏，然后组装上解密器/解压器到文件中，运行是先运行解密/解压器，将加密压缩内容解密解压，然后继续运行原始代码。</p>
<p><strong>1. 加冷门壳</strong></p>
<p>壳也有特征，知名壳都已经被分析的非常多了，杀软基本都能查这类壳，或者自动脱壳，然后进行查杀。</p>
<p>所以加冷门壳，壳特征未被分析，不能自动脱壳，可以更好隐藏原始代码，得到免杀效果。</p>
<p><strong>2. 加壳改壳</strong></p>
<p>将常用壳进行修改，让壳特征变化，也可以是杀软失效。</p>
<p>比如修改入口，区段信息修改，入口代码移位。</p>
<p>可以类比为免杀壳，上面介绍的方法都可以使用。</p>
<h1 id="行为动态免杀"><a href="#行为动态免杀" class="headerlink" title="行为动态免杀"></a>行为动态免杀</h1><p>杀毒软件现在都会有主防的功能，对恶意行为进行拦截提示。</p>
<p>比如这些行为：</p>
<ol>
<li>注册表操作，添加启动项，添加服务</li>
<li>文件写入、读系统文件、删除文件，移动文件</li>
<li>杀进程，创建进程</li>
<li>注入、劫持等</li>
</ol>
<h2 id="行为拦截原理"><a href="#行为拦截原理" class="headerlink" title="行为拦截原理"></a>行为拦截原理</h2><p>说白了，恶意行为都是通过API调用来完成的，可能是一个API，可能是多个APi组合。</p>
<p>杀软通过技术手段拦截这些API调用，通过策略来判断是否属于恶意行为。</p>
<p>关键点：</p>
<ol>
<li>API</li>
<li>策略（顺序，调用源，参数等等）</li>
</ol>
<p>所以后面的方法就是针对这两点做的工作。</p>
<h2 id="如何进行行为免杀呢？"><a href="#如何进行行为免杀呢？" class="headerlink" title="如何进行行为免杀呢？"></a>如何进行行为免杀呢？</h2><p>下面介绍的方式对非源码、源码都有效，但是非源码修改起来非常非常麻烦…</p>
<p><strong>1. 替换api</strong></p>
<p>使用相同功能的API进行替换，杀软不可能拦截了所有API，所以这种方式还是有效的。比如MoveFileEx替换MoveFile。</p>
<p><strong>2. 未导出api</strong></p>
<p>寻找相同功能的未导出API进行替换，杀软拦截一般是导出API，或者底层调用，寻找未导出API有一定效果。</p>
<p>寻找方法，通过分析目标API内部调用，找到内部一个或多个未导出API，来完成相同功能。</p>
<p><strong>3. 重写api</strong></p>
<p>完全重写系统API功能（通过逆向），实现自己的对应功能API，对于ring3的行为拦截非常有效。比如实现MoveFile等。</p>
<p><strong>4. api+5</strong></p>
<p>ring3的API拦截通过是挂钩API头几个字节内容，然后进入杀软自己函数进行参数检查之类的。</p>
<p>那么如果调用API时，跳过头部几字节，就可以避开这种拦截方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__API:</span><br><span class="line">1 push ebp;</span><br><span class="line">2 mov ebp, esp;</span><br><span class="line">3 mov edi, edi;</span><br><span class="line">4 ...</span><br></pre></td></tr></table></figure>

<p>调用时，不适用1地址，而使用4地址，然后自己函数内部还原跳过几字节的调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__API_MY:</span><br><span class="line">push ebp;</span><br><span class="line">mov ebp, esp;</span><br><span class="line">mov edi, edi;</span><br><span class="line">call 4</span><br></pre></td></tr></table></figure>

<p><strong>5. 底层api</strong></p>
<p>该方法类似于2和3，杀软拦截API可能更加高层（语义更清楚），那就可以找更底层API进行调用，绕过拦截，比如使用NT函数。</p>
<p>或者通过DeviceIoControl调用驱动功能来完成API功能。</p>
<p>模拟系统调用。</p>
<p><strong>6. 合理替换调用顺序</strong></p>
<p>有时拦截行为是通过多个API组合来完成的，所以合理替换顺序，绕过杀软拦截策略，也可以绕过改行为拦截。</p>
<p>比如，先创建服务，再将服务对应文件拷贝过去。</p>
<p><strong>7. 绕过调用源</strong></p>
<p>通过调用其它进行功能来完成API的功能。比较经典的如，通过rundll32.exe来完成dll加载，通过COM来操作文件等等。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>方法大概就总结到这，要更好的完成免杀，需要各种方式进行合理灵活组合变化，或者挖掘更多的方法。</p>
<h2 id="注意-技巧"><a href="#注意-技巧" class="headerlink" title="注意/技巧"></a>注意/技巧</h2><ol>
<li>非源码修改时，通过OD能够更好的完成，配合IDA进行观察，具体参考OD/IDA使用教程。</li>
<li>源码免杀加花，要灵活多变，不拘于形式。</li>
<li>行为免杀多尝试，猜出杀软拦截策略，能够更有效的找到绕过方式。</li>
</ol>
<blockquote>
<p>道高一尺，魔高一丈</p>
</blockquote>
<p>各路大神有更多的技巧和方式，请不吝赐教，相互交流。</p>
<p>我们不做坏事，但是可以了解做坏事的手段，更好的破坏防御这些手段。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="http://blog.csdn.net/cwqbuptcwqbupt/article/details/7591818" target="_blank" rel="noopener">模糊哈希算法的原理与应用</a></li>
<li><a href="http://www.freebuf.com/sectool/40580.html" target="_blank" rel="noopener">VirTest5.0特征码定位器（开源）</a></li>
<li><a href="http://baike.baidu.com/link?url=ExY1OF52Md1Lk6G_WMZQf4fdswE2RSjuhPmXEYRwgVhkSIb-udf0AhK1cqbhmnDsnf21pUJSvHEWnMoxwZfZ5asnxw0W76Ew9t5ZIJRbLxO" target="_blank" rel="noopener">http://baike.baidu.com/link?url=ExY1OF52Md1Lk6G_WMZQf4fdswE2RSjuhPmXEYRwgVhkSIb-udf0AhK1cqbhmnDsnf21pUJSvHEWnMoxwZfZ5asnxw0W76Ew9t5ZIJRbLxO</a></li>
</ol>
<p>转载请注明出处：<a href="https://anhkgg.github.io/aanti-virus" target="_blank" rel="noopener">https://anhkgg.github.io/aanti-virus</a></p>

    </div>

    
    
    

    <div>
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

    
    </div>
      <div>
        

<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Wh0ale</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wh0ale.github.io/2019/01/23/2019-1-23-免杀方法大集合/" title="免杀方法大集结">https://wh0ale.github.io/2019/01/23/2019-1-23-免杀方法大集合/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>

    <footer class="post-footer">
          
        
        <div class="post-tags">
            <a href="/tags/免杀/" rel="tag"><i class="fa fa-tag"></i># 免杀</a>
          
        </div>
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
              <a href="/2019/01/22/2019-1-20-SSRF详解/" rel="next" title="ssrf详解">
                <i class="fa fa-chevron-left"></i> ssrf详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
              <a href="/2019/01/23/2019-1-23-后渗透详解/" rel="prev" title="后渗透详细篇">
                后渗透详细篇 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
    </footer>
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  


        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.gif"
      alt="Wh0ale">
  <p class="site-author-name" itemprop="name">Wh0ale</p>
  <div class="site-description motion-element" itemprop="description">No master and rookie，only hardworking and lazy.</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">126</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/Wh0ale" title="GitHub &rarr; https://github.com/Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://medium.com/@Wh0ale" title="Medium &rarr; https://medium.com/@Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-medium"></i>Medium</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="/AttackerWh0ale@gmail.com" title="Mail &rarr; AttackerWh0ale@gmail.com"><i class="fa fa-fw fa-envelope"></i>Mail</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://twitter.com/Wh0ale" title="Twitter &rarr; https://twitter.com/Wh0ale" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
    
  </div>
  <div class="cc-license motion-element" itemprop="license">
    
  
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-Hans" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#简介"><span class="nav-number">2.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#静态免杀"><span class="nav-number">3.</span> <span class="nav-text">静态免杀</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#怎么找特征码"><span class="nav-number">3.1.</span> <span class="nav-text">怎么找特征码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#工具查找"><span class="nav-number">3.1.1.</span> <span class="nav-text">工具查找</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手工查找"><span class="nav-number">3.1.2.</span> <span class="nav-text">手工查找</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他"><span class="nav-number">3.1.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#怎么免杀？"><span class="nav-number">3.2.</span> <span class="nav-text">怎么免杀？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#手工修改"><span class="nav-number">3.2.1.</span> <span class="nav-text">手工修改</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#非源码"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">非源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">源码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工具免杀（盲免杀）"><span class="nav-number">3.2.2.</span> <span class="nav-text">工具免杀（盲免杀）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#资源操作"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">资源操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PE操作"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">PE操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加壳"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">加壳</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#行为动态免杀"><span class="nav-number">4.</span> <span class="nav-text">行为动态免杀</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#行为拦截原理"><span class="nav-number">4.1.</span> <span class="nav-text">行为拦截原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何进行行为免杀呢？"><span class="nav-number">4.2.</span> <span class="nav-text">如何进行行为免杀呢？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#注意-技巧"><span class="nav-number">5.1.</span> <span class="nav-text">注意/技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.2.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wh0ale</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:33</span>
</div>

<div>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("03/31/2019 00:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>
  <script src="/lib/reading_progress/reading_progress.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>



  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  























  <script src="/js/local-search.js?v=7.3.0"></script>













    
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">
<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '925b9aa350afc793e04c',
    clientSecret: 'bcd92ef416b81450a12e6388b00dfa49f798437a',
    repo: 'Wh0ale.github.io',
    owner: 'Wh0ale',
    admin: ['Wh0ale'],
    id: md5(location.pathname),
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>


</body>
</html>
